"use strict";(function(){if(Object.prototype.clone){return}Object.prototype.clone=function(expKey){let map=new WeakMap;let src=this;let retObj=clone(src);map=null;return retObj;function clone(src){let dst;if(nodom.isObject(src)){dst=new Object;map.set(src,dst);Object.getOwnPropertyNames(src).forEach(prop=>{if(expKey){if(expKey.constructor===RegExp&&expKey.test(prop)||expKey.constructor===String&&expKey===prop){return}}if(nodom.isObject(src[prop])||nodom.isArray(src[prop])){let co=null;if(!map.has(src[prop])){co=clone(src[prop]);map.set(src[prop],co)}else{co=map.get(src[prop])}dst[prop]=co}else{dst[prop]=src[prop]}})}else if(nodom.isArray(src)){dst=new Array;map.set(src,dst);src.forEach(function(item,i){if(nodom.isObject(item)||nodom.isArray(item)){dst[i]=clone(item)}else{dst[i]=item}})}return dst}}})();class nodom{static genId(){if(this.generatedId===undefined){this.generatedId=1}return this.generatedId++}static merge(){for(let i=0;i<arguments.length;i++){if(!nodom.isObject(arguments[i])){throw Error.handle("invoke","nodom.merge",i,"object")}}let retObj=Object.assign.apply(null,arguments);subObj(retObj);return retObj;function subObj(retObj){for(let o in retObj){if(nodom.isObject(retObj[o])||nodom.isArray(retObj[o])){retObj[o]=retObj[o].clone()}}}}static assign(obj1,obj2){if(Object.assign){Object.assign(obj1,obj2)}else{nodom.getOwnProps(obj2).forEach(function(p){obj1[p]=obj2[p]})}return obj1}static getOwnProps(obj){if(!obj){return[]}return Object.getOwnPropertyNames(obj)}static isFunction(foo){return foo!==undefined&&foo!==null&&foo.constructor===Function}static isArray(obj){return Array.isArray(obj)}static isObject(obj){return obj!==null&&obj!==undefined&&obj.constructor===Object}static isInt(x){return Number.isInteger(x)}static isNumber(v){return typeof v==="number"}static isBoolean(v){return typeof v==="boolean"}static isString(str){return typeof str==="string"}static isNumberString(str){return/^\d+\.?\d*$/.test(str)}static isEmpty(obj){if(obj===null||obj===undefined)return true;let tp=typeof obj;if(nodom.isObject(obj)){let keys=Object.keys(obj);if(keys!==undefined){return keys.length===0}}else if(tp==="string"){return obj===""}return false}static findObjByProps(obj,props,one){if(!nodom.isObject(obj)){throw Error.handle("invoke","nodom.findObjByProps",0,"Object")}one=one||false;let ps=nodom.getOwnProps(props);let find=false;if(one===false){find=true;for(let i=0;i<ps.length;i++){let p=ps[i];if(obj[p]!==props[p]){find=false;break}}}else{for(let i=0;i<ps.length;i++){let p=ps[i];if(obj[p]===props[p]){console.log(p);find=true;break}}}if(find){return obj}for(let p in obj){let o=obj[p];if(o!==null){if(nodom.isObject(o)){let oprops=nodom.getOwnProps(o);for(let i=0;i<oprops.length;i++){let item=oprops[i];if(item!==null&&nodom.isObject(item)){let r=nodom.findObjByProps(item,props,one);if(r!==null){return r}}}}else if(nodom.isArray(o)){for(let i=0;i<o.length;i++){let item=o[i];if(item!==null&&nodom.isObject(item)){let r=nodom.findObjByProps(item,props,one);if(r!==null){return r}}}}}}return null}static get(selector,findAll,pview){pview=pview||document;if(findAll===true){return pview.querySelectorAll(selector)}return pview.querySelector(selector)}static append(el,dom){if(nodom.isNode(dom)){el.appendChild(dom)}else if(nodom.isString(dom)){let div=nodom.newEl("div");div.innerHTML=dom;nodom.transChildren(div,el)}}static isEl(el){return el instanceof HTMLElement}static isNode(node){return node!==undefined&&node!==null&&(node.nodeType===Node.TEXT_NODE||node.nodeType===Node.ELEMENT_NODE||node.nodeType===Node.DOCUMENT_FRAGMENT_NODE)}static getTranslate(el){let tr=el.style.transform;let arr;if(tr&&tr!=="none"){arr=[];let va=tr.substring(tr.indexOf("(")+1,tr.indexOf(")")-1);va=va.split(",");for(let i=0;i<va.length;i++){arr.push(parseInt(va[i]))}}if(arr){return arr}return[0,0,0]}static newEl(tagName,config,text){if(!nodom.isString(tagName)||nodom.isEmpty(tagName)){throw Error.handle("invoke","nodom.newEl",0,"string")}let el=document.createElement(tagName);if(nodom.isObject(config)){nodom.attr(el,config)}else if(nodom.isString(text)){el.innerHTML=text}return el}static newSvgEl(tagName){return document.createElementNS("http://www.w3.org/2000/svg",tagName)}static replaceNode(srcNode,nodes,srcPropCopy){if(!nodom.isNode(srcNode)){throw Error.handle("invoke","nodom.replaceNode",0,"Node")}if(!nodom.isNode(nodes)&&!nodom.isArray(nodes)){throw Error.handle("invoke1","nodom.replaceNode",1,"Node","Node Array")}srcPropCopy=srcPropCopy||false;let pnode=srcNode.parentNode;let bnode=srcNode.nextSibling;if(pnode===null){return}pnode.removeChild(srcNode);if(!nodom.isArray(nodes)){nodes=[nodes]}nodes.forEach(function(node){if(bnode===undefined||bnode===null){pnode.appendChild(node)}else{pnode.insertBefore(node,bnode)}if(srcPropCopy!==false){srcPropCopy=true}if(srcPropCopy&&srcNode.$isView){nodom.copyProp(node,srcNode)}})}static insertAfter(newNode,srcNode,pNode){const me=this;if(!nodom.isNode(newNode)){throw Error.handle("invoke","nodom.insertAfter",0,"Node")}if(!nodom.isNode(srcNode)&&!nodom.isNode(pNode)){throw Error.handle("invoke2","nodom.insertAfter",1,2,"Node")}let bNode=null;if(srcNode===undefined||srcNode===null){bNode=pNode.firstChild}else{pNode=srcNode.parentNode;bNode=srcNode.nextSibling}if(!nodom.isNode(pNode)){return}if(bNode===null){if(nodom.isArray(newNode)){newNode.forEach(function(n){if(me.isEl(n)){pNode.appendChild(n)}})}else{pNode.appendChild(newNode)}}else{if(nodom.isArray(newNode)){newNode.forEach(function(n){if(me.isEl(n)){pNode.insertBefore(n,bNode)}})}else{pNode.insertBefore(newNode,bNode)}}}static empty(el){const me=this;if(!me.isEl(el)){throw Error.handle("invoke","nodom.empty",0,"Element")}let nodes=el.childNodes;for(let i=nodes.length-1;i>=0;i--){el.removeChild(nodes[i])}}static remove(node){const me=this;if(!me.isNode(node)){throw Error.handle("invoke","nodom.remove",0,"Node")}if(node.parentNode!==null){node.parentNode.removeChild(node)}}static attr(el,param,value){const me=this;if(!me.isEl(el)){throw Error.handle("invoke","nodom.attr",0,"Element")}if(nodom.isEmpty(param)){throw Error.handle("invoke","nodom.attr",1,"string","object")}if(value===undefined||value===null){if(nodom.isObject(param)){nodom.getOwnProps(param).forEach(function(k){if(k==="value"){el[k]=param[k]}else{el.setAttribute(k,param[k])}})}else if(nodom.isString(param)){if(param==="value"){return param.value}return el.getAttribute(param)}}else{if(param==="value"){el[param]=value}else{el.setAttribute(param,value)}}}static width(el,value){if(!nodom.isEl(el)){throw Error.handle("invoke","nodom.width",0,"Element")}if(nodom.isNumber(value)){el.style.width=value+"px"}else{let compStyle;if(window.getComputedStyle){compStyle=window.getComputedStyle(el,null)}if(!compStyle){return null}let w=parseInt(compStyle["width"]);if(value===true){let pw=parseInt(compStyle["panodom.ngLeft"])+parseInt(compStyle["panodom.ngRight"]);w-=pw}return w}}static height(el,value){if(!nodom.isEl(el)){throw Error.handle("invoke","nodom.height",0,"Element")}if(nodom.isNumber(value)){el.style.height=value+"px"}else{let compStyle;if(window.getComputedStyle){compStyle=window.getComputedStyle(el,null)}if(!compStyle){return null}let w=parseInt(compStyle["height"]);if(value===true){let pw=parseInt(compStyle["panodom.ngTop"])+parseInt(compStyle["panodom.ngBotto,"]);w-=pw}return w}}static addClass(el,cls){if(!nodom.isEl(el)){throw Error.handle("invoke","nodom.addClass",0,"Element")}if(nodom.isEmpty(cls)){throw Error.handle("invoke","nodom.addClass",1,"string")}let cn=el.className.trim();if(nodom.isEmpty(cn)){el.className=cls}else{let arr=cn.split(/\s+/);for(let i=0;i<arr.length;i++){if(arr[i]===cls){return}}arr.push(cls);el.className=arr.join(" ")}}static removeClass(el,cls){if(!nodom.isEl(el)){throw Error.handle("invoke","nodom.removeClass",0,"Element")}if(nodom.isEmpty(cls)){throw Error.handle("invoke","nodom.removeClass",1,"string")}let cn=el.className.trim();if(!nodom.isEmpty(cn)){let arr=cn.split(/\s+/);for(let i=0;i<arr.length;i++){if(arr[i]===cls){arr.splice(i,1);el.className=arr.join(" ");return}}}}static formatDate(srcDate,format){if(nodom.isString(srcDate)){let reg=new RegExp(/^\d+$/);if(reg.exec(srcDate)!==null){try{srcDate=parseInt(srcDate)}catch(e){}}}srcDate=new Date(srcDate);if(isNaN(srcDate.getDay())){return""}let o={"M+":srcDate.getMonth()+1,"d+":srcDate.getDate(),"h+":srcDate.getHours()%12===0?12:srcDate.getHours()%12,"H+":srcDate.getHours(),"m+":srcDate.getMinutes(),"s+":srcDate.getSeconds(),"q+":Math.floor((srcDate.getMonth()+3)/3),S:srcDate.getMilliseconds()};let week={0:"日",1:"一",2:"二",3:"三",4:"四",5:"五",6:"六"};if(/(y+)/.test(format)){format=format.replace(RegExp.$1,(srcDate.getFullYear()+"").substr(4-RegExp.$1.length))}nodom.getOwnProps(o).forEach(function(k){if(new RegExp("("+k+")").test(format)){format=format.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+o[k]).substr((""+o[k]).length))}});if(/(E+)/.test(format)){format=format.replace(RegExp.$1,(RegExp.$1.length>1?RegExp.$1.length>2?"/u661f/u671f":"/u5468":"")+week[srcDate.getDay()+""])}return format}static toDate(dateStr){let date1;try{date1=new Date(Date.parse(dateStr))}catch(e){}if(!date1){throw Error.handle("invoke","nodom.toDate",0,"date string")}if(isNaN(date1)||isNaN(date1.getDay())){if(dateStr.length===14){dateStr=dateStr.substr(0,4)+"/"+dateStr.substr(4,2)+"/"+dateStr.substr(6,2)+" "+dateStr.substr(8,2)+":"+dateStr.substr(10,2)+":"+dateStr.substr(12);date1=new Date(Date.parse(dateStr))}else if(dateStr.length===8){dateStr=dateStr.substr(0,4)+"/"+dateStr.substr(4,2)+"/"+dateStr.substr(6,2);date1=new Date(Date.parse(dateStr))}}return date1}static compileStr(){let reg=new RegExp(/\{.+?\}/);let arr=[];let r;let args=arguments;let str=args[0];while((r=reg.exec(str))!==null){let rep;let sIndex=r[0].substr(1,r[0].length-2);let pIndex=parseInt(sIndex)+1;if(args[pIndex]!==undefined){rep=args[pIndex]}else{rep=""}str=str.replace(reg,rep)}return str}static addStrQuot(srcStr,quot){srcStr=srcStr.replace(/\'/g,"\\'");srcStr=srcStr.replace(/\"/g,'\\"');srcStr=srcStr.replace(/\`/g,"\\`");quot=quot||'"';srcStr=quot+srcStr+quot;return srcStr}static apply(foo,obj,args){return Reflect.apply(foo,obj,args)}}nodom.config={renderTick:50,appPath:"/page/",deviceType:"ontouchend"in document?1:2,routerPrePath:"/route"};class Class{static add(clsName,cls){this.items.set(clsName,cls)}static getClass(clsName){return this.items.get(clsName)}static newInstance(clsName,params){let cls=this.items.get(clsName);if(cls===undefined){return null}return Reflect.construct(cls,params||[])}static getClassName(obj){if(obj.constructor){return obj.constructor.name}}}Class.items=new Map;class Linker{constructor(type,config){const me=this;let p;switch(type){case"ajax":p=me.ajax(config);break;case"getfiles":p=me.getfiles(config);break;case"dolist":if(arguments.length===3){p=me.dolist(arguments[1],0,arguments[2])}else{p=me.dolist(arguments[1],0)}}return p}ajax(config){return new Promise((resolve,reject)=>{if(config.rand){config.params=config.params||{};config.params.$rand=Math.random()}const url=config.url;const async=config.async===false?false:true;const req=new XMLHttpRequest;req.withCredentials=config.withCredentials;const reqType=config.reqType||"GET";req.timeout=async?config.timeout:0;req.onload=(()=>{if(req.status===200){let r=req.responseText;if(config.type==="json"){try{r=JSON.parse(r)}catch(e){reject({type:"jsonparse"})}}resolve(r)}else{reject({type:"error",url:url})}});req.ontimeout=(()=>reject({type:"timeout"}));req.onerror=(()=>reject({type:"error",url:url}));switch(reqType){case"GET":let pa;if(nodom.isObject(config.params)){let ar=[];nodom.getOwnProps(config.params).forEach(function(key){ar.push(key+"="+config.params[key])});pa=ar.join("&")}if(pa!==undefined){if(url.indexOf("?")!==-1){url+="&"+pa}else{url+="?"+pa}}req.open(reqType,url,async,config.user,config.pwd);req.send(null);break;case"POST":let fd=new FormData;for(let o in config.params){fd.append(o,config.params[o])}req.open(reqType,url,async,config.user,config.pwd);req.send(fd);break}}).catch(re=>{switch(re.type){case"error":throw Error.handle("notexist1",nodom.words.resource,re.url);case"timeout":throw Error.handle("timeout");case"jsonparse":throw Error.handle("jsonparse")}})}getfiles(urls){let promises=[];urls.forEach(url=>{promises.push(new Promise((resolve,reject)=>{const req=new XMLHttpRequest;req.onload=(()=>resolve(req.responseText));req.onerror=(()=>reject(url));req.open("GET",url);req.send()}))});return Promise.all(promises).catch(text=>{throw Error.handle("notexist1",nodom.words.resource,text)})}dolist(funcArr,index,paramArr){const me=this;return foo(funcArr,index,paramArr);function foo(fa,i,pa){if(fa.length===0){return Promise.resolve()}else{return new Promise((resolve,reject)=>{if(pa!==null||pa!==undefined){fa[i](resolve,reject,pa[i])}else{fa[i](resolve,reject)}}).then(success=>{if(i<fa.length-1){return foo(fa,i+1,pa)}})}}}}class Factory{constructor(module){if(module!==undefined){this.moduleName=module.name}this.items=Object.create(null)}add(name,item){this.items[name]=item}get(name){return this.items[name]}remove(name){delete this.items[name]}}class MessageFactory{static add(from,to,data){this.messages.push({from:from,to:to,msg:data,read:false})}static broadcast(){for(let i=0;i<MessageFactory.messages.length;i++){let msg=MessageFactory.messages[i];let module=ModuleFactory.get(msg.to);if(module&&module.state===2||module.state===3){module.receive(msg.from,msg.msg)}if(module&&module.state>=2){MessageFactory.messages.splice(i--,1)}}}}MessageFactory.messages=new Array;class ModuleFactory{static add(name,item){this.items.set(name,item)}static get(name){return this.items.get(name)}static remove(name){this.items.delete(name)}static setMain(m){this.mainModule=m}static getMain(){return this.mainModule}}ModuleFactory.items=new Map;ModuleFactory.mainModule=undefined;class ExpressionFactory extends Factory{}class DirectiveFactory extends Factory{}class Compiler{static compile(view){return compileEl(view)}static compile(module,elementStr){let dom=new Element;const div=nodom.newEl("div");div.innerHTML=elementStr;dom.isRoot=true;this.compileDom(module,div,dom);return dom}static compileDom(module,ele,parent){const me=this;let oe=new Element;let props=oe.props;let isComment=false;switch(ele.nodeType){case Node.ELEMENT_NODE:oe.tagName=ele.tagName;for(let i=0;i<ele.attributes.length;i++){let attr=ele.attributes[i];let v=attr.value.trim();if(attr.name.startsWith("x-")){oe.directives.push(new Directive(attr.name.substr(2),v,oe,module,ele))}else if(attr.name.startsWith("e-")){let en=attr.name.substr(2);oe.events[en]=new Event(en,attr.value.trim())}else{let isExpr=false;if(v!==""){let ra=me.compileExpression(module,v);if(nodom.isArray(ra)){oe.exprProps[attr.name]=ra;isExpr=true}}if(!isExpr){oe.props[attr.name]=v}}}let subEls=[];ele.childNodes.forEach(function(nd){subEls.push(me.compileDom(module,nd,oe))});oe.directives.sort((a,b)=>{return DirectiveManager.getType(a.type).prio-DirectiveManager.getType(b.type).prio});break;case Node.TEXT_NODE:let txt=ele.textContent;if(txt===""){return}let expA=me.compileExpression(module,txt);if(typeof expA==="string"){oe.textContent=expA}else{oe.expressions=expA}break;case Node.COMMENT_NODE:isComment=true;break}if(!isComment&&parent){parent.children.push(oe)}return oe}static compileExpression(module,exprStr){let reg=new RegExp("{{.+?}}","g");if(reg.test(exprStr)===false){return exprStr}let retA=new Array;let ite=exprStr.matchAll(/\{\{.+?\}\}/g);let re,oIndex=0;for(re of ite){let ind=re.index;if(ind>oIndex){let s=exprStr.substring(oIndex,ind);retA.push(s)}let exp=new Expression(re[0].substring(2,re[0].length-2),module);module.expressionFactory.add(exp.id,exp);retA.push(exp.id);oIndex=ind+re[0].length}if(re&&re.index+re[0].length<exprStr.length-1){retA.push(exprStr.substr(re.index+re[0].length))}return retA}}class Renderer{static add(module){const me=this;if(module.state!==3){return}if(me.waitList.indexOf(module.name)===-1){me.waitList.push(module.name)}}static remove(module){let ind;if((ind=me.waitList.indexOf(module.name))!==-1){me.waitList.splice(ind,1)}}static render(){const me=this;for(let i=0;i<Renderer.waitList.length;i++){let m=ModuleFactory.get(Renderer.waitList[i]);if(!m||m.render()){Renderer.waitList.splice(i--,1)}}}}Renderer.waitList=[];class Scheduler{static dispatch(){Scheduler.tasks.forEach(foo=>{if(nodom.isFunction(foo)){foo()}})}static start(){Scheduler.dispatch();if(window.requestAnimationFrame){window.requestAnimationFrame(Scheduler.start)}else{window.setTimeout(Scheduler.start,nodom.config.renderTick)}}static addTask(foo){if(!nodom.isFunction(foo)){throw Error.handle("invoke","Scheduler.addTask","0","function")}if(Scheduler.tasks.indexOf(foo)!==undefined){Scheduler.tasks.push(foo)}}static removeTask(foo){if(!nodom.isFunction(foo)){throw Error.handle("invoke","Scheduler.removeTask","0","function")}let ind=-1;if((ind=Scheduler.tasks.indexOf(foo))!==-1){Scheduler.tasks.splice(ind,1)}}}Scheduler.tasks=[];Scheduler.addTask(MessageFactory.broadcast);Scheduler.addTask(Renderer.render);Scheduler.start();class Expression{constructor(exprStr,module){const me=this;me.fields=[];me.modelMap={};me.id=nodom.genId();if(module){me.moduleName=module.name;module.expressionFactory.add(me.id,me)}if(exprStr){me.stack=this.init(exprStr)}}init(exprStr){const me=this;let startStr=undefined;let type=0;let strings="'`\"";let operand="()!|*/+-><=&%";let spaceChar=" \t";let stack=new Array;let sTmp="";for(let i=0;i<exprStr.length;i++){let c=exprStr[i];if(type!==1&&spaceChar.indexOf(c)!==-1){continue}switch(type){case 1:if(strings.indexOf(c)!==-1){if(c===startStr){me.addStr(sTmp+c,stack);startStr=undefined;sTmp="";type=0;continue}}break;case 2:if(operand.indexOf(c)!==-1){if(c==="("){type=3}else{me.addVar(sTmp,stack);sTmp="";type=0}}break;case 3:if(c===")"){let a=sTmp.trim().split("(");let fn=a[0];let pa=a[1].split(",");for(let j=0;j<pa.length;j++){let field=pa[j].trim();pa[j]=field;me.addField(field)}stack.push({val:fn,params:pa,type:"function"});sTmp="";type=0;continue}break;default:if(strings.indexOf(c)!==-1){startStr=c;type=1}else if(operand.indexOf(c)===-1){type=2;if(sTmp!==""){me.addStr(sTmp,stack);sTmp=""}}}let isFilter=false;if(c==="|"){let j=i+1;let nextc=exprStr[j];if(nextc>="a"&&nextc<="z"){let strCh="";for(;j<exprStr.length;j++){let ch=exprStr[j];if(strings.indexOf(ch)!==-1){if(ch===strCh){strCh=""}else{strCh=ch}}if(strCh===""&&operand.indexOf(ch)!==-1){break}}}if(j>i){let s=exprStr.substring(i+1,j);if(s!==""){let filterArr=FilterManager.explain(s);if(FilterManager.hasType(filterArr[0])){me.addFilter(filterArr,stack);c="";exprStr="";isFilter=true}}}}if(!isFilter&&type!==1&&type!==3&&operand.indexOf(c)!==-1){me.addOperand(c,stack)}else{sTmp+=c}}if(type===2){me.addVar(sTmp,stack)}else if(type===0&&sTmp!==""){me.addStr(sTmp,stack)}else if(type!==0){throw Error.handle("invoke","expression",0,"Node")}return stack}val(model,modelId){const me=this;if(!model){return""}if(me.stack===null){return""}let fieldObj;if(model instanceof Model){modelId=model.id;fieldObj=Object.create(null);me.fields.forEach(field=>{fieldObj[field]=me.getFieldValue(model,field)})}else{fieldObj=model}let newFieldValue="";me.fields.forEach(field=>{newFieldValue+=fieldObj[field]});if(me.modelMap[modelId]===undefined){me.modelMap[modelId]=Object.create(null)}if(me.modelMap[modelId].fieldValue!==newFieldValue){me.modelMap[modelId].value=me.cacStack(me.stack,fieldObj,modelId)}me.modelMap[modelId].fieldValue=newFieldValue;return me.modelMap[modelId].value}addVar(field,stack){const me=this;let values=["null","undefined","true","false","NaN"];let addFlag=values.indexOf(field)===-1?false:true;addFlag=addFlag||nodom.isNumberString(field);if(addFlag){this.addStr(field,stack)}else{stack.push({val:field.trim(),type:"field"});me.addField(field)}}addStr(str,stack){if(stack.length>0&&stack[stack.length-1].type==="string"){stack[stack.length-1].val+=str}else{stack.push({val:str,type:"string"})}}addOperand(str,stack){stack.push({val:str,type:"operand"})}addFilter(filterArr,stack){const me=this;let module=ModuleFactory.get(me.moduleName);if(stack.length>0){let filterStack=[];let pre=stack[stack.length-1];let type=pre.type;if(type==="field"||type==="function"||type==="string"){filterStack.push(stack.pop())}else if(type==="operand"&&pre.val===")"){let cnt=1;let j=stack.length-2;for(;j>=0;j--){if(stack[j].val==="("){if(--cnt===0){break}}else if(stack[j].val===")"){cnt++}}filterStack=stack.slice(j,stack.length);stack.splice(j,stack.length-j)}let expr=new Expression(null,module);expr.stack=filterStack;expr.fields=me.fields;if(!me.pre){me.pre=[]}me.pre.push(expr.id);stack.push({type:"filter",filter:new Filter(filterArr),val:expr.id})}}cacStack(stack,fieldObj,modelId){const me=this;let retStr="";let needEval=false;let module=ModuleFactory.get(me.moduleName);stack.forEach(item=>{let value="";switch(item.type){case"string":retStr+=item.val;break;case"operand":retStr+=item.val;needEval=true;break;case"field":value=fieldObj[item.val];if(nodom.isString(value)&&value!==""){value=nodom.addStrQuot(value)}retStr+=value;break;case"function":let foo=module.methodFactory.get(item.val);let param=[];if(item.params.length>0){item.params.forEach(p=>{let pv=fieldObj[p];let isVal=false;if(nodom.isString(pv)&&pv!==""){pv=nodom.addStrQuot(pv)}param.push(pv)})}if(foo!==undefined&&nodom.isFunction(foo)){value=foo.apply(module.model,param)}else{value=item.val+"("+param.join(",")+")";needEval=true}retStr+=value;break;case"filter":value=module.expressionFactory.get(item.val).val(fieldObj,modelId);value=item.filter.exec(value,module);if(typeof value==="object"){retStr=value}else{if(nodom.isString(value)&&value!==""){value=nodom.addStrQuot(value)}retStr+=value}}});if(needEval){try{retStr=eval(retStr)}catch(e){}}else if(nodom.isString(retStr)&&retStr.charAt(0)==='"'){retStr=retStr.substring(1,retStr.length-1)}return retStr}addField(field){const me=this;if(me.fields.indexOf(field)===-1){me.fields.push(field)}}getFieldValue(model,field){const me=this;let module=ModuleFactory.get(me.moduleName);if(!model&&module){model=module.model}if(!model){return""}let v=model.query(field);if(v===undefined&&model!==module.model){v=module.model.query(field)}return v===undefined?"":v}}class Element{constructor(tag){const me=this;me.directives=[];me.props={};me.events={};me.exprProps={};me.changeProps=[];me.removeProps=[];me.children=[];me.parentKey=undefined;me.tagName=tag||undefined;me.dontRender=false;me.key=nodom.genId()}render(module,parent){const me=this;if(parent){me.parentKey=parent.key;if(!me.modelId){me.modelId=parent.modelId}}if(me.tagName!==undefined){me.handleProps(module);me.handleDirectives(module,parent)}else{me.handleTextContent(module)}if(!me.dontRender){for(let i=0;i<me.children.length;i++){let item=me.children[i];item.render(module,me);if(item.dontRender){me.removeChild(item);i--}}}return true}renderToHtml(module,params){const me=this;let el,el1;let type=params.type;let parent=params.parent;let modelFac=module.modelFactory;if(!parent){el=module.container}else{if(type==="fresh"||type==="add"||type==="text"){el=module.container.querySelector("[key='"+parent.key+"']")}else if(me.tagName!==undefined){el=module.container.querySelector("[key='"+me.key+"']")}}if(!el){return}switch(type){case"fresh":if(me.tagName){el1=newEl(me,null,el);genSub(el1,me)}else{el1=newText(me.textContent,me)}el.appendChild(el1);break;case"text":if(!parent||!parent.children){break}let ind=parent.children.indexOf(me);if(ind!==-1){let div=document.querySelector("[key='"+me.key+"']");if(me.type==="html"){if(div!==null){div.innerHTML="";div.appendChild(me.textContent)}else{div=newText(me.textContent);nodom.replaceNode(el.childNodes[ind],div)}}else{el.childNodes[ind].textContent=me.textContent}}break;case"upd":if(params.removeProps){params.removeProps.forEach(p=>{el.removeAttribute(p)})}params.changeProps.forEach(p=>{if(el.tagName==="INPUT"&&p.p==="value"){el.value=p.v}else{el.setAttribute(p.p,p.v)}});break;case"rep":el1=newEl(me,parent);nodom.replaceNode(el,el1);break;case"add":if(me.tagName){el1=newEl(me,parent,el);genSub(el1,me)}else{el1=newText(me.textContent)}if(params.index===el.childNodes.length){el.appendChild(el1)}else{el.insertBefore(el1,el.childNodes[params.index])}}function newEl(vdom,parent,parentEl){let el=document.createElement(vdom.tagName);nodom.getOwnProps(vdom.props).forEach(p=>{el.setAttribute(p,vdom.props[p])});el.setAttribute("key",vdom.key);vdom.handleEvents(module,el,parent,parentEl);return el}function newText(text,dom){if(dom&&"html"===dom.type){let div=nodom.newEl("div");div.setAttribute("key",dom.key);div.appendChild(text);return div}else{return document.createTextNode(text)}}function genSub(pEl,vNode){if(vNode.children&&vNode.children.length>0){vNode.children.forEach(item=>{let el1;if(item.tagName){el1=newEl(item,vNode,pEl);genSub(el1,item)}else{el1=newText(item.textContent,item)}pEl.appendChild(el1)})}}}clone(){const me=this;let dst=new Element;nodom.getOwnProps(me).forEach(p=>{if(typeof me[p]!=="object"){dst[p]=me[p]}});me.directives.forEach(d=>{dst.directives.push(d)});nodom.getOwnProps(me.props).forEach(d=>{dst.props[d]=me.props[d]});nodom.getOwnProps(me.exprProps).forEach(d=>{dst.exprProps[d]=me.exprProps[d]});nodom.getOwnProps(me.events).forEach(d=>{dst.events[d]=me.events[d].clone()});dst.expressions=me.expressions;me.children.forEach(d=>{dst.children.push(d.clone())});return dst}handleDirectives(module,parent){const me=this;if(me.dontRender){return false}const dirs=me.directives;for(let i=0;i<dirs.length&&!me.dontRender;i++){DirectiveManager.exec(dirs[i],me,module,parent)}return true}handleExpression(exprArr,module){const me=this;if(me.dontRender){return}let value="";let model=module.modelFactory.get(me.modelId);exprArr.forEach(v=>{if(typeof v==="number"){let v1=module.expressionFactory.get(v).val(model);if(v1 instanceof DocumentFragment||nodom.isEl(v1)){me.type="html";return v1}value+=v1}else{value+=v}});return value}handleProps(module){const me=this;if(me.dontRender){return}nodom.getOwnProps(me.exprProps).forEach(item=>{if(nodom.isArray(me.exprProps[item])){me.props[item]=me.handleExpression(me.exprProps[item],module)}else if(me.exprProps[item]instanceof Expression){me.props[item]=me.exprProps[item].val(module.modelFactory.get(me.modelId))}})}handleTextContent(module){const me=this;if(me.dontRender){return}if(me.expressions!==undefined){me.textContent=me.handleExpression(me.expressions,module)}}handleEvents(module,el,parent,parentEl){const me=this;if(me.events.length===0){return}nodom.getOwnProps(me.events).forEach(en=>{let ev=me.events[en];if(ev.delg&&parent){ev.delegateTo(module,me,el,parent,parentEl)}else{ev.bind(module,me,el)}})}removeDirectives(delDirectives){const me=this;for(let i=me.directives.length-1;i>=0;i--){let d=me.directives[i];for(let j=0;j<delDirectives.length;j++){if(d.type===delDirectives[j]){me.directives.splice(i,1)}}}}hasDirective(directiveType){const me=this;for(let i=0;i<me.directives.length;i++){if(me.directives[i].type===directiveType){return true}}return false}getDirective(directiveType){const me=this;for(let i=0;i<me.directives.length;i++){if(me.directives[i].type===directiveType){return me.directives[i]}}}add(dom){me.children.push(dom)}remove(module,html){const me=this;if(me.parentKey!==undefined){let p=module.renderTree.query(me.parentKey);if(p){p.removeChild(me)}}if(html&&module&&module.container){let el=module.container.querySelector("[key='"+me.key+"']");if(el!==null){nodom.remove(el)}}me.free()}removeFromHtml(module){const me=this;let el=module.container.querySelector("[key='"+me.key+"']");if(el!==null){nodom.remove(el)}}removeChild(dom){const me=this;let ind=-1;if(nodom.isArray(me.children)&&(ind=me.children.indexOf(dom))!==-1){me.children.splice(ind,1)}}replace(dst){const me=this;if(!dst.parent){return false}let ind=dst.parent.children.indexOf(dst);if(ind===-1){return false}dst.parent.children.splice(ind,1,me);return true}contains(dom){const me=this;for(;dom!==undefined&&dom!==me;dom=dom.parent);return dom!==undefined}query(key){const me=this;if(me.key===key){return me}for(let i=0;i<me.children.length;i++){let dom=me.children[i].query(key);if(dom){return dom}}}queryProp(prop,value){const me=this;if(me.key===key){return me}for(let i=0;i<me.children.length;i++){let dom=me.children[i].query(key);if(dom){return dom}}}compare(dst,retArr,parentNode){if(!dst){return}const me=this;let re=Object.create(null);let change=false;if(me.tagName===undefined){if(dst.tagName===undefined){if(me.textContent!==dst.textContent){re.type="text";change=true}}else{re.type="rep";change=true}}else{if(me.tagName!==dst.tagName){re.type="rep";change=true}else{re.changeProps=[];re.removeProps=[];nodom.getOwnProps(dst.props).forEach(p=>{if(!me.props.hasOwnProperty(p)){re.removeProps.push(p)}});nodom.getOwnProps(me.props).forEach(p=>{if(me.props[p]!==dst.props[p]){re.changeProps.push({p:p,v:me.props[p]})}});if(re.changeProps.length>0||re.removeProps.length>0){change=true;re.type="upd"}}}if(change){re.node=me;if(parentNode){re.parent=parentNode}retArr.push(re)}if(!me.children||me.children.length===0){if(dst.children&&dst.children.length>0){dst.children.forEach(item=>{retArr.push({type:"del",node:item})})}}else{if(!dst.children||dst.children.length===0){me.children.forEach(item=>{retArr.push({type:"add",node:item,parent:me})})}else{me.children.forEach((dom1,ind)=>{let dom2=dst.children[ind];if(!dom2||dom1.key!==dom2.key){dom2=undefined;for(let i=0;i<dst.children.length;i++){if(dom1.key===dst.children[i].key){dom2=dst.children[i];break}}}if(dom2!==undefined){dom1.compare(dom2,retArr,me);dom2.finded=true}else{retArr.push({type:"add",node:dom1,parent:me,index:ind})}});if(dst.children&&dst.children.length>0){dst.children.forEach(item=>{if(!item.finded){retArr.push({type:"del",node:item,parent:dst})}})}}}}}class Event{constructor(eventName,eventStr){const me=this;me.events=undefined;me.name=eventName;if(eventStr){eventStr.split(":").forEach((item,i)=>{item=item.trim();if(i===0){me.handler=item}else{me[item]=true}})}if(nodom.config.deviceType===1){switch(me.name){case"click":me.name="tap";break;case"mousedown":me.name="touchstart";break;case"mouseup":me.name="touchend";break;case"mousemove":me.name="touchmove";break}}else{switch(me.name){case"tap":me.name="click";break;case"touchstart":me.name="mousedown";break;case"touchend":me.name="mouseup";break;case"touchmove":me.name="mousemove";break}}}fire(e){const me=this;const module=ModuleFactory.get(me.moduleName);const dom=module.renderTree.query(me.domKey);if(!module.hasContainer()){return}const el=module.container.querySelector("[key='"+me.domKey+"']");const model=module.modelFactory.get(dom.modelId);if(me.capture){handleSelf(e,model,module,el);handleDelg(e,model,module,el)}else{if(handleDelg(e,model,module,el)){handleSelf(e,model,module,el)}}if(me.events!==undefined&&me.events[me.name].length===0&&me.handler===undefined){if(ExternalEvent.TouchEvents[me.name]){ExternalEvent.unregist(me,el)}else{if(el!==null){el.removeEventListener(me.name,me.handleEvent)}}}function handleDelg(e,model,module,el){if(me.events===undefined){return true}let arr=me.events[me.name];if(nodom.isArray(arr)){if(arr.length>0){for(let i=0;i<arr.length;i++){if(arr[i].el&&arr[i].el.contains(e.target)){arr[i].fire(e);if(arr[i].once){me.removeSubEvt(arr[i])}if(arr[i].nopopo){return false}}}}else{me.events.delete(me.name)}}return true}function handleSelf(e,model,module,el){let foo=module.methodFactory.get(me.handler);if(nodom.isFunction(foo)){if(me.nopopo){e.stopPropagation()}nodom.apply(foo,model,[e,module,el,dom]);if(me.once){delete me.handler}}}}bind(module,vdom,el){const me=this;me.domKey=vdom.key;me.moduleName=module.name;if(ExternalEvent.TouchEvents[me.name]){ExternalEvent.regist(me,el,module,vdom)}else{me.handleEvent=function(e){me.fire(e)};el.addEventListener(me.name,me.handleEvent,me.capture)}}delegateTo(module,vdom,el,parent,parentEl){const me=this;me.domKey=vdom.key;me.moduleName=module.name;if(!parentEl){parentEl=document.body}if(!parent.events[me.name]){let ev=new Event(me.name);ev.bind(module,parent,parentEl);parent.events[me.name]=ev}parent.events[me.name].addSubEvt(me)}addSubEvt(ev){const me=this;if(!me.events){me.events=Object.create(null)}if(!me.events[me.name]){me.events[me.name]=new Array}me.events[me.name].push(ev)}removeSubEvt(ev){const me=this;if(me.events===undefined||me.events[ev.name]===undefined){return}let ind=me.events[ev.name].indexOf(ev);if(ind!==-1){me.events[ev.name].splice(ind,1);if(me.events[ev.name].length===0){me.events.delete(ev.name)}}}clone(){const me=this;let evt=new Event(me.name);let arr=["delg","once","nopopo","useCapture","handler","handleEvent","module"];arr.forEach(item=>{evt[item]=me[item]});return evt}}class ExternalEvent{static regist(evtObj,el){let evt=ExternalEvent.TouchEvents[evtObj.name];if(!nodom.isEmpty(evtObj.touchListeners)){ExternalEvent.unregist(evtObj)}if(!el){const module=ModuleFactory.get(evtObj.moduleName);el=module.container.querySelector("[key='"+evtObj.domKey+"']")}evtObj.touchListeners={};if(evt&&el!==null){nodom.getOwnProps(evt).forEach(function(ev){evtObj.touchListeners[ev]=function(e){evt[ev](e,evtObj)};el.addEventListener(ev,evtObj.touchListeners[ev],evtObj.capture)})}}static unregist(evtObj,el){let evt=nodom.Event.TouchEvents[evtObj.eventName];if(!el){const module=ModuleFactory.get(evtObj.moduleName);el=module.container.querySelector("[key='"+evtObj.domKey+"']")}if(evt){if(el!==null){nodom.getOwnProps(evtObj.touchListeners).forEach(function(ev){el.removeEventListener(ev,evtObj.touchListeners[ev])})}}}}ExternalEvent.TouchEvents={tap:{touchstart:function(e,evtObj){let tch=e.touches[0];evtObj.extParams={pos:{sx:tch.pageX,sy:tch.pageY,t:Date.now()}}},touchmove:function(e,evtObj){let pos=evtObj.extParams.pos;let tch=e.touches[0];let dx=tch.pageX-pos.sx;let dy=tch.pageY-pos.sy;if(Math.abs(dx)>5||Math.abs(dy)>5){pos.move=true}},touchend:function(e,evtObj){let pos=evtObj.extParams.pos;let dt=Date.now()-pos.t;if(pos.move===true||dt>200){return}evtObj.fire(e)}},swipe:{touchstart:function(e,evtObj){let tch=e.touches[0];let t=Date.now();evtObj.extParams={swipe:{oldTime:[t,t],speedLoc:[{x:tch.pageX,y:tch.pageY},{x:tch.pageX,y:tch.pageY}],oldLoc:{x:tch.pageX,y:tch.pageY}}}},touchmove:function(e,evtObj){let nt=Date.now();let tch=e.touches[0];let mv=evtObj.extParams["swipe"];if(nt-mv.oldTime>50){mv.speedLoc[0]={x:mv.speedLoc[1].x,y:mv.speedLoc[1].y};mv.speedLoc[1]={x:tch.pageX,y:tch.pageY};mv.oldTime[0]=mv.oldTime[1];mv.oldTime[1]=nt}mv.oldLoc={x:tch.pageX,y:tch.pageY}},touchend:function(e,evtObj){let mv=evtObj.extParams["swipe"];let nt=Date.now();let ind=nt-mv.oldTime[1]<30?0:1;let dx=mv.oldLoc.x-mv.speedLoc[ind].x;let dy=mv.oldLoc.y-mv.speedLoc[ind].y;let s=Math.sqrt(dx*dx+dy*dy);let dt=nt-mv.oldTime[ind];if(dt>300||s<10){return}let v0=s/dt;if(v0>.05){let sname="";if(dx<0&&Math.abs(dy/dx)<1){e.v0=v0;sname="swipeleft"}if(dx>0&&Math.abs(dy/dx)<1){e.v0=v0;sname="swiperight"}if(dy>0&&Math.abs(dx/dy)<1){e.v0=v0;sname="swipedown"}if(dy<0&&Math.abs(dx/dy)<1){e.v0=v0;sname="swipeup"}if(evtObj.name===sname){evtObj.fire(e)}}}}};ExternalEvent.TouchEvents["swipeleft"]=ExternalEvent.TouchEvents["swipe"];ExternalEvent.TouchEvents["swiperight"]=ExternalEvent.TouchEvents["swipe"];ExternalEvent.TouchEvents["swipeup"]=ExternalEvent.TouchEvents["swipe"];ExternalEvent.TouchEvents["swipedown"]=ExternalEvent.TouchEvents["swipe"];nodom.words={system:"系统",module:"模块",moduleClass:"模块类",model:"模型",directive:"指令",expression:"表达式",event:"事件",method:"方法",filter:"过滤器",filterType:"过滤器类型",data:"数据",dataItem:"数据项",route:"路由",routeView:"路由容器",plugin:"插件",resource:"资源",method:"方法"};nodom.ErrorMsgs={unknown:"未知错误",paramException:"{0}'{1}'方法参数错误，请参考api",invoke:"{0}方法调用参数{1}必须为{2}",invoke1:"{0}方法调用参数{1}必须为{2}或{3}",invoke2:"{0}方法调用参数{1}或{2}必须为{3}",invoke3:"{0}方法调用参数{1}不能为空",exist:"{0}已存在",exist1:"{0}'{1}'已存在",notexist:"{0}不存在",notexist1:"{0}'{1}'不存在",notupd:"{0}不可修改",notremove:"{0}不可删除",notremove1:"{0}{1}不可删除",namedinvalid:"{0}{1}命名错误，请参考用户手册对应命名规范",initial:"{0}初始化参数错误",jsonparse:"JSON解析错误",timeout:"请求超时"};nodom.FormMsgs={type:"请输入有效的{0}",unknown:"输入错误",required:"不能为空",min:"最小输入值为{0}",max:"最大输入值为{0}"};class Error{static handle(errname){var reg=new RegExp(/\{.+?\}/);var msg=nodom.ErrorMsgs[errname];if(msg===undefined){return"未知错误"}var args=[msg];for(var i=1;i<arguments.length;i++){args.push(arguments[i])}return nodom.compileStr.apply(null,args)}}class ModelFactory extends Factory{}class Model{constructor(data,module){const me=this;me.data=data;me.fields={};me.id=nodom.genId();if(module){me.moduleName=module.name;if(module.modelFactory){module.modelFactory.add(me.id,me)}}data.$modelId=me.id;me.addSetterGetter(data,module)}set(key,value){const me=this;let fn,data;let index=key.lastIndexOf(".");if(index!==-1){fn=key.substr(index+1);key=key.substr(0,index);data=me.query(key)}else{fn=key;data=me.data}if(data===undefined){throw Error.handle("notexist1",nodom.words.dataItem,key)}if(data[fn]!==value){let module=ModuleFactory.get(me.moduleName);if(nodom.isObject(value)||nodom.isArray(value)){new Model(value,module)}let model=module.modelFactory.get(data.$modelId);if(model){if(data[fn]===undefined){me.defineProp(data,fn)}model.update(fn,value)}data[fn]=value}}update(field,value){const me=this;let change=false;if(nodom.isString(field)){if(me.fields[field]!==value){me.fields[field]=value;change=true}}if(change){ModuleFactory.get(me.moduleName).dataChange(me)}}addSetterGetter(data){const me=this;if(nodom.isObject(data)){nodom.getOwnProps(data).forEach(function(p){let v=data[p];if(nodom.isObject(v)||nodom.isArray(v)){new Model(v,ModuleFactory.get(me.moduleName))}else{me.update(p,v);me.defineProp(data,p)}})}else if(nodom.isArray(data)){let watcher=["push","unshift","splice","pop","shift","reverse","sort"];let module=ModuleFactory.get(me.moduleName);watcher.forEach(function(item){data[item]=function(){let args=[];switch(item){case"push":for(let i=0;i<arguments.length;i++){args.push(arguments[i])}break;case"unshift":for(let i=0;i<arguments.length;i++){args.push(arguments[i])}break;case"splice":if(arguments.length>2){for(let i=2;i<arguments.length;i++){args.push(arguments[i])}}break;case"pop":module.deleteData(data[data.length-1].$modelId);break;case"shift":module.deleteData(data[0].$modelId);break}me.update(data);Array.prototype[item].apply(data,arguments);args.forEach(arg=>{if(nodom.isObject(arg)||nodom.isArray(arg)){new Model(arg,ModuleFactory.get(me.moduleName))}})}});data.forEach(item=>{if(nodom.isObject(item)||nodom.isArray(item)){new Model(item,ModuleFactory.get(me.moduleName))}})}}defineProp(data,p){const me=this;Object.defineProperty(data,p,{set:function(v){if(me.fields[p]===v){return}me.update(p,v);data[p]=v},get:function(){if(me.fields[p]!==undefined){return me.fields[p]}}})}query(name){const me=this;let data=me.data;let fa=name.split(".");for(let i=0;i<fa.length&&null!==data&&typeof data==="object";i++){if(data===undefined){return}if(fa[i].charAt(fa[i].length-1)==="]"){let f=fa[i].split("[");data=data[f[0]];f.shift();f.forEach(istr=>{let ind=istr.substr(0,istr.length-1);data=data[parseInt(ind)]})}else{data=data[fa[i]]}}return data}}class Filter{constructor(src){if(nodom.isString(src)){src=FilterManager.explain(src)}if(src){this.type=src[0];this.params=src.slice(1)}}exec(value,module){let args=[module,this.type,value].concat(this.params);return nodom.apply(FilterManager.exec,module,args)}}class DirectiveManager{static addType(name,config){if(this.directiveTypes.has(name)){throw Error.handle("exist1",nodom.words.directiveType,name)}if(!nodom.isObject(config)){throw Error.handle("invoke","DirectiveManager.addType",1,"Function")}config.prio=config.prio||10;this.directiveTypes.set(name,config)}static removeType(name){if(this.cantEditTypes.indexOf(name)!==-1){throw Error.handle("notupd",nodom.words.system+nodom.words.directiveType,name)}if(!this.directiveTypes.has(name)){throw Error.handle("notexist1",nodom.words.directiveType,name)}delete this.directiveTypes.delete(name)}static getType(name){return this.directiveTypes.get(name)}static hasType(name){return this.directiveTypes.has(name)}static init(directive,dom,module,el){let dt=this.directiveTypes.get(directive.type);if(dt===undefined){throw Error.handle("notexist1",nodom.words.directiveType,name)}return dt.init(directive,dom,module,el)}static exec(directive,dom,module,parent){let args=arguments;args[0]=directive;if(!this.directiveTypes.has(directive.type)){throw Error.handle("notexist1",nodom.words.directiveType,type)}return nodom.apply(this.directiveTypes.get(directive.type).handle,null,args)}}DirectiveManager.directiveTypes=new Map;DirectiveManager.cantEditTypes=["model","repeat","if","else","show","class","field"];class Directive{constructor(type,value,vdom,module){const me=this;me.type=type;if(nodom.isString(value)){me.value=value.trim()}if(type!==undefined){nodom.apply(DirectiveManager.init,DirectiveManager,[me,vdom,module])}me.id=nodom.genId()}exec(value){let args=[this.module,this.type,value].concat(this.params);return nodom.apply(DirectiveManager.exec,DirectiveManager,args)}}class Module{constructor(config){const me=this;me.id=nodom.genId();me.firstRender=true;me.rendered=false;me.virtualDom=undefined;me.renderTree=undefined;me.parentName=undefined;me.children=undefined;me.selector=undefined;me.isMain=false;me.firstRenderOps=[];me.beforeFirstRenderOps=[];me.containerParam=undefined;me.state=0;if(config.name){me.name=config.name}else{me.name="Module"+nodom.genId()}ModuleFactory.add(me.name,me);me.methodFactory=new MethodFactory(me);me.modelFactory=new ModelFactory(me);me.expressionFactory=new ExpressionFactory(me);me.directiveFactory=new DirectiveFactory(me);me.renderDoms=[];if(config){me.initConfig=config;if(nodom.isString(config.el)){me.containerParam={module:config.parentName,selector:config.el}}else if(nodom.isEl(config.el)){me.container=config.el}if(nodom.isObject(config.methods)){nodom.getOwnProps(config.methods).forEach(item=>{me.methodFactory.add(item,config.methods[item])})}me.templateStr="";if(me.hasContainer()){me.templateStr=me.container.innerHTML.trim();me.container.innerHTML=""}if(config.root){me.isMain=true;ModuleFactory.setMain(me);me.active()}if(!config.delayInit||me.isMain){me.init()}}}init(){const me=this;if(me.state!==0||me.initing){return me.initLinker}me.initing=true;let config=me.initConfig;let typeArr=[];let urlArr=[];let appPath=nodom.config.appPath||"";if(nodom.isArray(config.requires)&&config.requires.length>0){config.requires.forEach(item=>{let type;let url="";if(nodom.isObject(item)){type=item.type||"js";url+=item.path}else{type="js";url+=item}if(type==="css"){let css=nodom.get("link[href='"+url+"']");if(cs!==null){return}css=nodom.newEl("link");css.type="text/css";css.rel="stylesheet";css.href=path;head.appendChild(css);return}else if(type==="js"){let cs=nodom.get("script[dsrc='"+url+"']");if(cs!==null){return}}typeArr.push(type);urlArr.push(url)})}if(config.template){me.templateStr+=config.template.trim()}else if(config.templateUrl){typeArr.push("template");urlArr.push(appPath+config.templateUrl)}else if(config.compiledTemplate){typeArr.push("compiled");urlArr.push(appPath+config.compiledTemplate)}if(!nodom.isEmpty(me.templateStr)){me.virtualDom=Compiler.compile(me,me.templateStr);delete me.templateStr}if(config.data){me.model=new Model(config.data,me)}else if(config.dataUrl){typeArr.push("data");urlArr.push(config.dataUrl)}if(typeArr.length>0){me.initLinker=new Linker("getfiles",urlArr).then(files=>{let head=document.querySelector("head");files.forEach((file,ind)=>{switch(typeArr[ind]){case"js":let script=nodom.newEl("script");script.innerHTML=file;head.appendChild(script);script.setAttribute("dsrc",urlArr[ind]);script.innerHTML="";head.removeChild(script);break;case"template":me.virtualDom=Compiler.compile(me,file.trim());break;case"compiled":let arr=Serializer.deserialize(file,me);me.virtualDom=arr[0];me.expressionFactory=arr[1];break;case"data":me.model=new Model(JSON.parse(file),me)}});changeState(me);delete me.initing})}else{me.initLinker=Promise.resolve();changeState(me);delete me.initing}if(nodom.isArray(me.initConfig.modules)){me.initConfig.modules.forEach(item=>{me.addChild(item)})}delete me.initConfig;return me.initLinker;function changeState(mod){if(mod.isMain){mod.state=3;Renderer.add(mod)}else if(mod.parentName){mod.state=ModuleFactory.get(mod.parentName).state}else{mod.state=1}}}render(){const me=this;if(me.state!==3||!me.virtualDom||!me.hasContainer()){return false}let root=me.virtualDom.clone(me);if(me.firstRender){me.doModuleEvent("onBeforeFirstRender");me.beforeFirstRenderOps.forEach(foo=>{nodom.apply(foo,me,[])});me.beforeFirstRenderOps=[];me.renderTree=root;if(me.model){root.modelId=me.model.id}root.render(me,null);if(root.children){root.children.forEach(item=>{item.renderToHtml(me,{type:"fresh"})})}delete me.firstRender;setTimeout(()=>{me.doModuleEvent("onFirstRender");me.firstRenderOps.forEach(foo=>{nodom.apply(foo,me,[])});me.firstRenderOps=[]},0)}else{me.doModuleEvent("onBeforeRender");if(me.model){root.modelId=me.model.id;let oldTree=me.renderTree;me.renderTree=root;root.render(me,null);root.compare(oldTree,me.renderDoms);for(let i=me.renderDoms.length-1;i>=0;i--){let item=me.renderDoms[i];if(item.type==="del"){item.node.removeFromHtml(me);me.renderDoms.splice(i,1)}}me.renderDoms.forEach(item=>{item.node.renderToHtml(me,item)})}setTimeout(()=>{me.doModuleEvent("onRender")},0)}me.renderDoms=[];if(nodom.isArray(me.children)){me.children.forEach(item=>{item.render()})}return true}hasContainer(){const me=this;if(me.container){return true}else if(me.containerParam!==undefined){let ct;if(me.containerParam.module===undefined){ct=document}else{let module=ModuleFactory.get(me.containerParam.module);if(module){ct=module.container}}if(ct){me.container=ct.querySelector(me.containerParam.selector);return me.container!==null}}return false}dataChange(model){Renderer.add(this)}addChild(config){const me=this;config.parentName=me.name;let chd=new Module(config);if(me.children===undefined){me.children=[]}me.children.push(chd);return chd}send(toName,data){MessageFactory.add(this.name,toName,data)}broadcast(data){const me=this;if(me.parentName){let pmod=ModuleFactory.get(me.parentName);if(pmod&&pmod.children){me.send(pmod.name,data);pmod.children.forEach(m=>{if(m===me){return}me.send(m.name,data)})}}if(me.children!==undefined){me.children.forEach(m=>{me.send(m.name,data)})}}receive(fromName,data){this.doModuleEvent("onReceive",[fromName,data])}active(callback){const me=this;if(me.state===3){return}let linker;if(me.state===0){me.init().then(()=>{me.state=3;if(nodom.isFunction(callback)){callback(me.model)}Renderer.add(me)})}else{me.state=3;if(callback){callback(me.model)}Renderer.add(me)}if(nodom.isArray(me.children)){me.children.forEach(m=>{m.active(callback)})}if(!linker){return Promise.resolve()}return linker}unactive(){const me=this;if(me.isRoot||me.state===2){return}me.state=2;me.firstRender=true;delete me.container;if(nodom.isArray(me.children)){me.children.forEach(m=>{m.unactive()})}}dead(){if(this.state===4){return}me.state=4;if(nodom.isArray(me.children)){me.children.forEach(m=>{m.unactive()})}}destroy(){if(nodom.isArray(me.children)){me.children.forEach(m=>{m.destroy()})}ModuleFactory.remove(me.name)}doModuleEvent(eventName,param){const me=this;let foo=me.methodFactory.get(eventName);if(!param){param=[me.model]}if(nodom.isFunction(foo)){nodom.apply(foo,me.model,param)}}addFirstRenderOperation(foo){let me=this;if(!nodom.isFunction(foo)){return}if(me.firstRenderOps.indexOf(foo)===-1){me.firstRenderOps.push(foo)}}addBeforeFirstRenderOperation(foo){let me=this;if(!nodom.isFunction(foo)){return}if(me.beforeFirstRenderOps.indexOf(foo)===-1){me.beforeFirstRenderOps.push(foo)}}}class MethodFactory extends Factory{invoke(name,params){const me=this;let foo=me.get(name);if(!nodom.isFunction(foo)){throw new Exception(nodom.ErrorMsgs.notexist1,nodom.words.method,name)}return nodom.apply(foo,me.module.model,params)}}class Router{static addPath(path){const me=this;for(let i=0;i<me.waitList.length;i++){let li=me.waitList[i];if(li===path){return}if(li.indexOf(path)===0&&li.indexOf(path.length+1)==="/"){return}}me.waitList.push(path);me.load()}static load(){const me=this;if(me.loading||me.waitList.length===0){return}let path=me.waitList.shift();me.loading=true;me.start(path)}static start(path){const me=this;let diff=me.compare(me.currentPath,path);let parentModule=diff[0]===null?ModuleFactory.getMain():ModuleFactory.get(diff[0].module);for(let i=diff[1].length-1;i>=0;i--){const r=diff[1][i];if(!r.module){continue}let module=ModuleFactory.get(r.module);if(nodom.isFunction(me.onDefaultLeave)){me.onDefaultLeave(module.model)}if(nodom.isFunction(r.onLeave)){r.onLeave(module.model)}module.unactive()}let operArr=[];let paramArr=[];let showPath;if(diff[2].length===0){if(diff[0]!==null){setRouteParamToModel(diff[0]);if(!diff[0].useParentPath){showPath=diff[0].fullPath}diff[0].setLinkActive(true)}}else{for(let i=0;i<diff[2].length;i++){let route=diff[2][i];if(!route||!route.module){continue}if(!route.useParentPath){showPath=route.fullPath}if(!parentModule.routerKey){throw Error.handle("notexist",nodom.words.routeView)}Router.moduleRouteMap[route.module]=route.id;paramArr.push(route.module);operArr.push((resolve,reject,moduleName)=>{let module=ModuleFactory.get(moduleName);module.addBeforeFirstRenderOperation(function(){nodom.empty(module.container)});module.containerParam={module:parentModule.name,selector:"[key='"+parentModule.routerKey+"']"};module.active(model=>{let route=Router.routes.get(Router.moduleRouteMap[module.name]);if(!route){return}route.setLinkActive(true);delete Router.moduleRouteMap[module.name];setRouteParamToModel(route);if(nodom.isFunction(me.onDefaultEnter)){me.onDefaultEnter(model)}if(nodom.isFunction(route.onEnter)){route.onEnter(model)}parentModule=module;if(resolve){resolve()}})})}}if(!showPath){if(!me.getRoute(path)){throw Error.handle("notexist1",nodom.words.route,path)}}if(me.startStyle!==2&&showPath){if(me.showPath&&showPath.indexOf(me.showPath)===0){history.replaceState(path,"",nodom.config.routerPrePath+showPath)}else{history.pushState(path,"",nodom.config.routerPrePath+showPath)}me.showPath=showPath}if(operArr.length===0){Router.loading=false;Router.startStyle=0;return}me.currentPath=path;new Linker("dolist",operArr,paramArr).then(()=>{Router.loading=false;me.load();Router.startStyle=0}).catch(e=>{throw e});function setRouteParamToModel(route){if(!route){return}let module=ModuleFactory.get(route.module);let model=module.model;let o={path:route.path};if(!nodom.isEmpty(route.data)){o.data=route.data}if(!model){module.model=new Model({$route:o},module)}else{model.data["$route"]=o}Renderer.add(module)}}static redirect(path){this.addPath(path)}static addRoute(route,parent){if(RouterTree.add(route,parent)===false){throw Error.handle("exist1",nodom.words.route,route.path)}this.routes.set(route.id,route)}static getRoute(path,last){if(!path){return null}let routes=RouterTree.get(path);if(routes===null||routes.length===0){return null}if(last){return routes[routes.length-1]}else{return routes}}static compare(path1,path2){const me=this;let arr1=null;let arr2=null;if(path1){arr1=me.getRoute(path1)}if(path2){arr2=me.getRoute(path2)}let len=0;if(arr1!==null){len=arr1.length}if(arr2!==null){if(arr2.length<len){len=arr2.length}}else{len=0}let retArr1=[],retArr2=[];let i=0;for(i=0;i<len;i++){if(arr1[i].id===arr2[i].id){if(JSON.stringify(arr1[i].data)!==JSON.stringify(arr2[i].data)){i++;break}}else{break}}if(arr1!==null){for(let j=i;j<arr1.length;j++){retArr1.push(arr1[j])}}if(arr2!==null){for(let j=i;j<arr2.length;j++){retArr2.push(arr2[j])}}let p1=null,p2=null;if(arr1!==null&&i>0){for(let j=i-1;j>=0&(p1===null||p2===null);j--){if(arr1[j].module!==undefined){if(p1===null){p1=arr1[j]}else if(p2===null){p2=arr1[j]}}}}return[p1,retArr1,retArr2,p2]}static changeActive(module,path){if(!module||!path||path===""||!module.routerActiveViews){return}module.routerActiveViews.forEach(item=>{let dom=module.renderTree.query(item);if(!dom){return}if(dom.exprProps.hasOwnProperty("active")){let model=module.modelFactory.get(dom.modelId);if(!model){return}let expr=module.expressionFactory.get(dom.exprProps["active"][0]);if(!expr){return}let field=expr.fields[0];if(path.indexOf(dom.props["path"])===0){model.data[field]=true}else{model.data[field]=false}}else if(dom.props.hasOwnProperty("active")){if(path.indexOf(dom.props["path"])===0){dom.props["active"]=true}else{dom.props["active"]=false}}})}}Router.loading=false;Router.routes=new Map;Router.currentPath="";Router.showPath="";Router.waitList=[];Router.currentIndex=0;Router.onDefaultEnter=undefined;Router.onDefaultLeave=undefined;Router.moduleRouteMap={};Router.startStyle=0;class Route{constructor(config){const me=this;me.params=[];me.data={};me.children=[];me.onEnter=config.onEnter;me.onLeave=config.onLeave;me.useParentPath=config.useParentPath;me.path=config.path;me.module=config.module instanceof Module?config.module.name:config.module;if(config.path===""){return}me.id=nodom.genId();if(!config.notAdd){Router.addRoute(me,config.parent)}if(nodom.isArray(config.routes)){config.routes.forEach(item=>{item.parent=me;new Route(item)})}}setLinkActive(ancestor){let path=this.fullPath;let module=ModuleFactory.get(this.module);if(module&&module.containerParam){let pm=ModuleFactory.get(module.containerParam.module);if(pm){Router.changeActive(pm,path)}}if(ancestor&&this.parent){this.parent.setLinkActive(true)}}}class RouterTree{static add(route,parent){const me=this;if(!me.root){me.root=new Route({path:"",notAdd:true})}let pathArr=route.path.split("/");let node=parent||me.root;let path="";let param=[];let routeValue;let paramIndex=-1;let prePath="";for(let i=0;i<pathArr.length;i++){let v=pathArr[i].trim();if(v===""){pathArr.splice(i--,1);continue}if(v.startsWith(":")){if(param.length===0){paramIndex=i}param.push(v.substr(1))}else{paramIndex=-1;param=[];route.path=v;let j=0;for(;j<node.children.length;j++){let r=node.children[j];if(r.path===v){node=r;break}}if(j===node.children.length){if(prePath!==""){node.children.push(new Route({path:prePath,notAdd:true}));node=node.children[node.children.length-1]}prePath=v}}if(paramIndex===-1){route.params=[]}else{route.params=param}}if(node!==undefined&&node!==route){route.path=prePath;node.children.push(route)}return true}static get(path){const me=this;if(!me.root){throw Error.handle("notexist",nodom.words.root)}let pathArr=path.split("/");let node=me.root;let paramIndex=0;let retArr=[];let fullPath="";let preNode=me.root;for(let i=0;i<pathArr.length;i++){let v=pathArr[i].trim();if(v===""){pathArr.splice(i--,1);continue}let find=false;for(let j=0;j<node.children.length;j++){if(node.children[j].path===v){if(preNode!==me.root){preNode.fullPath=fullPath;preNode.data=node.data;retArr.push(preNode)}node=node.children[j];node.data={};preNode=node;find=true;break}}fullPath+="/"+v;if(!find){if(paramIndex<node.params.length){node.data[node.params[paramIndex++]]=v}}}if(node!==me.root){node.fullPath=fullPath;retArr.push(node)}return retArr}}window.addEventListener("popstate",function(e){const state=history.state;if(!state){return}Router.startStyle=2;Router.addPath(state)});DirectiveManager.addType("route",{init:(directive,dom,module)=>{let value=directive.value;if(nodom.isEmpty(value)){return}if(dom.tagName==="A"){dom.props["href"]="javascript:void(0)"}let dirObj={};if(value&&value.substr(0,2)==="{{"&&value.substr(value.length-2,2)==="}}"){let expr=new Expression(value.substring(2,value.length-2),module);dom.exprProps["path"]=expr;directive.value=expr}else{dom.props["path"]=value}let method="$nodomGenMethod"+nodom.genId();module.methodFactory.add(method,(e,module,view,dom)=>{let path=dom.props["path"];if(!path){return}Router.addPath(path)});dom.events["click"]=new Event("click",method)},handle:(directive,dom,module,parent)=>{if(!module.routerActiveViews){module.routerActiveViews=[]}if(module.routerActiveViews.indexOf(dom.key)===-1){module.routerActiveViews.push(dom.key);if(dom.props.hasOwnProperty("active")){let route=Router.getRoute(dom.props["path"],true);if(route===null){return}}}let path=dom.props["path"];if(path===Router.currentPath){return}if(dom.props["active"]&&dom.props["active"]!=="false"&&(!Router.currentPath||path.indexOf(Router.currentPath)===0)){Router.addPath(path)}}});DirectiveManager.addType("router",{init:(directive,dom,module)=>{module.routerKey=dom.key},handle:(directive,dom,module,parent)=>{return}});class Serializer{static serialize(module){let props=["virtualDom","expressionFactory"];let jsonStr="[";props.forEach((p,i)=>{addClsName(module[p]);let s=JSON.stringify(module[p]);jsonStr+=s;if(i<props.length-1){jsonStr+=","}else{jsonStr+="]"}});return jsonStr;function addClsName(obj){if(typeof obj!=="object"){return}let cls=Class.getClassName(obj);if(cls&&Class.getClass(cls)){obj.className=cls}nodom.getOwnProps(obj).forEach(item=>{if(nodom.isArray(obj[item])){if(obj[item].length===0){delete obj[item]}else{obj[item].forEach(item1=>{addClsName(item1)})}}else if(typeof obj[item]==="object"){if(nodom.isEmpty(obj[item])){delete obj[item]}else{addClsName(obj[item])}}})}}static deserialize(jsonStr,module){let jsonArr=JSON.parse(jsonStr);let arr=[];let vdom;jsonArr.forEach(item=>{arr.push(handleCls(item))});return arr;function handleCls(jsonObj){if(!nodom.isObject(jsonObj)){return jsonObj}if(jsonObj.moduleName){jsonObj.moduleName=module.name}let retObj;if(jsonObj.hasOwnProperty("className")){const cls=jsonObj["className"];let param=[];switch(cls){case"Directive":param=[jsonObj["type"],jsonObj["value"],vdom,module];break;case"Event":param=[jsonObj["name"]];break}retObj=Class.newInstance(cls,param);if(cls==="Element"){vdom=retObj}}else{retObj={}}let objArr=[];let arrArr=[];nodom.getOwnProps(jsonObj).forEach(item=>{if(nodom.isObject(jsonObj[item])){objArr.push(item)}else if(nodom.isArray(jsonObj[item])){arrArr.push(item)}else{if(item!=="className"){retObj[item]=jsonObj[item]}}});objArr.forEach(item=>{retObj[item]=handleCls(jsonObj[item])});arrArr.forEach(item=>{retObj[item]=[];jsonObj[item].forEach(item1=>{retObj[item].push(handleCls(item1))})});return retObj}}}class FilterManager{static addType(name,handler){if(!/^[a-zA-Z]+$/.test(name)){throw Error.handle("namedinvalid",nodom.words.filterType,name)}if(this.filterTypes.has(name)){throw Error.handle("exist1",nodom.words.filterType,name)}if(!nodom.isFunction(handler)){throw Error.handle("invoke","FilterManager.addType",1,"Function")}this.filterTypes.set(name,handler)}static removeType(name){if(this.cantEditTypes.indexOf(name)!==-1){throw Error.handle("notupd",nodom.words.system+nodom.words.filterType,name)}if(!this.filterTypes.has(name)){throw Error.handle("notexist1",nodom.words.filterType,name)}delete this.filterTypes.delete(name)}static hasType(name){return this.filterTypes.has(name)}static exec(module,type,value){let params=new Array;for(let i=2;i<arguments.length;i++){params.push(arguments[i])}if(!FilterManager.filterTypes.has(type)){throw Error.handle("notexist1",nodom.words.filterType,type)}return nodom.apply(FilterManager.filterTypes.get(type),module,params)}static explain(src){let startStr,startObj=false;let strings="\"'`";let splitCh=":";let retArr=new Array;let tmp="";for(let i=0;i<src.length;i++){let ch=src[i];if(strings.indexOf(ch)!==-1){if(ch===startStr){startStr=undefined}else{startStr=ch}}else if(startStr===undefined){if(ch==="}"&&startObj){startObj=false}else if(ch==="{"){startObj=true}}if(ch===splitCh&&startStr===undefined&&!startObj&&tmp!==""){retArr.push(handleObj(tmp));tmp="";continue}tmp+=ch}if(tmp!==""){retArr.push(handleObj(tmp))}return retArr;function handleObj(s){s=s.trim();if(s.charAt(0)==="{"){s=eval("("+s+")")}return s}}}FilterManager.filterTypes=new Map;FilterManager.cantEditTypes=["date","currency","number","tolowercase","touppercase","orderBy","filter"];DirectiveManager.addType("model",{prio:1,init:(directive,dom,module)=>{let value=directive.value;if(nodom.isString(value)){let arr=new Array;value.split(".").forEach(item=>{let ind1=-1,ind2=-1;if((ind1=item.indexOf("["))!==-1&&(ind2=item.indexOf("]"))!==-1){let fn=item.substr(0,ind1);let index=item.substring(ind1+1,ind2);arr.push(fn+","+index)}else{arr.push(item)}});directive.value=arr}},handle:(directive,dom,module,parent)=>{let model=module.modelFactory.get(dom.modelId);if(!model||!model.data){return}let data=model.data;directive.value.forEach(item=>{if(!data){return}if(item.indexOf(",")!==-1){let a=item.split(",");data=data[a[0]][parseInt(a[1])]}else{data=data[item]}});if(data){dom.modelId=data.$modelId}return true}});DirectiveManager.addType("repeat",{prio:2,init:(directive,dom,module)=>{let value=directive.value;if(!value){throw Error.handle("paramException","x-repeat")}let ind,filter,modelName;if((ind=value.indexOf("|"))!==-1){modelName=value.substr(0,ind).trim();directive.filter=new Filter(value.substr(ind+1))}else{modelName=value}if(!dom.hasDirective("mocel")){dom.directives.push(new Directive("model",modelName,dom,module))}directive.value=modelName},handle:(directive,dom,module,parent)=>{const modelFac=module.modelFactory;let rows=modelFac.get(dom.modelId).data;if(directive.filter!==undefined){rows=directive.filter.exec(rows,module)}if(rows===undefined||rows.length===0){dom.dontRender=true;return true}let chds=[];let key=dom.key;dom.removeDirectives(["model","repeat"]);for(let i=0;i<rows.length;i++){let node=dom.clone(module);node.modelId=rows[i].$modelId;setKey(node,key,node.modelId);rows[i].$index=i;chds.push(node)}if(chds.length>0){for(let i=0,len=parent.children.length;i<len;i++){if(parent.children[i]===dom){chds=[i+1,0].concat(chds);Array.prototype.splice.apply(parent.children,chds);break}}}dom.dontRender=true;return false;function setKey(node,key,id){node.key=key+"_"+id;node.children.forEach(dom=>{setKey(dom,dom.key,id)})}}});DirectiveManager.addType("if",{init:(directive,dom,module)=>{let value=directive.value;if(!value){throw Error.handle("paramException","x-repeat")}let expr=new Expression(value,module);directive.value=expr},handle:(directive,dom,module,parent)=>{let model=module.modelFactory.get(dom.modelId);let v=directive.value.val(model);let indif=-1,indelse=-1;for(let i=0;i<parent.children.length;i++){if(parent.children[i]===dom){indif=i}else if(indelse===-1&&parent.children[i].hasDirective("else")){indelse=i}if(i!==indif&&indif!==-1&&indelse===-1&&parent.children[i].tagName!==undefined){indelse=-2}if(indif!==-1&&indelse!==-1){break}}if(v&&v!=="false"){let ind=0;if(indelse>0){parent.children[indelse].dontRender=true}}else if(indelse>0){dom.dontRender=true}return true}});DirectiveManager.addType("else",{name:"else",init:(directive,dom,module)=>{return},handle:(directive,dom,module,parent)=>{return}});DirectiveManager.addType("show",{init:(directive,dom,module)=>{let value=directive.value;if(!value){throw Error.handle("paramException","x-show")}let expr=new Expression(value,module);directive.value=expr},handle:(directive,dom,module,parent)=>{let model=module.modelFactory.get(dom.modelId);let v=directive.value.val(model);let arr=dom.style?dom.style.split(";"):[];let find=false;let show=v&&v!=="false"?"block":"none";for(let i=0;i<arr.length;i++){if(arr[i].indexOf("display:")===-1){find=true;arr[i]="display:"+show;break}}if(!find){arr.push("display:"+show)}dom.props["style"]=arr.join(";")}});DirectiveManager.addType("class",{init:(directive,dom,module)=>{let obj=eval("("+directive.value+")");if(!nodom.isObject(obj)){return}let robj={};nodom.getOwnProps(obj).forEach(function(key){if(nodom.isString(obj[key])){robj[key]=new Expression(obj[key],module)}else{robj[key]=obj[key]}});directive.value=robj},handle:(directive,dom,module,parent)=>{let obj=directive.value;let clsArr=[];let cls=dom.props["class"];let model=module.modelFactory.get(dom.modelId);if(nodom.isString(cls)&&!nodom.isEmpty(cls)){clsArr=cls.trim().split(/\s+/)}nodom.getOwnProps(obj).forEach(function(key){let r=obj[key];if(r instanceof Expression){r=r.val(model)}let ind=clsArr.indexOf(key);if(!r||r==="false"){if(ind!==-1){clsArr.splice(ind,1)}}else if(ind===-1){clsArr.push(key)}});dom.props["class"]=clsArr.join(" ")}});DirectiveManager.addType("field",{init:(directive,dom,module)=>{let dv=directive.value;let field=dv;let tgname=dom.tagName.toLowerCase();let type=dom.props["type"];let eventName="input";if(tgname==="input"&&(type==="checkbox"||type==="radio")){eventName="change"}dom.props["name"]=field;let method="$nodomGenMethod"+nodom.genId();module.methodFactory.add(method,function(e,module,view,dom){let type=dom.props["type"];let model=module.modelFactory.get(dom.modelId);let field=dom.getDirective("field").value;let v=view.value;if(type==="checkbox"){if(dom.props["yes-value"]==v){v=dom.props["no-value"]}else{v=dom.props["yes-value"]}}else if(type==="radio"){if(!view.checked){v=undefined}}this.data[field]=v;if(type!=="radio"){dom.props["value"]=v;view.value=v}});dom.events[eventName]=new Event(eventName,method);setTimeout(()=>{if(!dom.exprProps.hasOwnProperty("value")&&!dom.props.hasOwnProperty("value")){dom.exprProps["value"]=new Expression(field,module)}},0)},handle:(directive,dom,module,parent)=>{const type=dom.props["type"];const tgname=dom.tagName.toLowerCase();const model=module.modelFactory.get(dom.modelId);const dataValue=model.data[directive.value];let value=dom.props["value"];if(type==="radio"){if(dataValue==value){dom.props["checked"]="checked"}else{delete dom.props["checked"]}}else if(type==="checkbox"){let yv=dom.props["yes-value"];if(dataValue==yv){dom.props["checked"]="checked";dom.props["value"]=yv}else{delete dom.props["checked"];dom.props["value"]=dom.props["no-value"]}}else if(tgname==="select"){dom.props["value"]=dataValue;setTimeout(function(){module.container.querySelector("[key='"+dom.key+"']").value=dataValue},0)}}});DirectiveManager.addType("validity",{init:(directive,dom,module)=>{let ind,fn,method;let value=directive.value;if((ind=value.indexOf("|"))!==-1){fn=value.substr(0,ind);method=value.substr(ind+1)}else{fn=value}directive.value=fn;directive.params={enabled:false};if(method){directive.params.method=method}setTimeout(()=>{if(dom.children.length===0){let vd1=new Element;vd1.textContent="   ";dom.children.push(vd1)}else{dom.children.forEach(item=>{if(item.children.length===0){let vd1=new Element;vd1.textContent="   ";item.children.push(vd1)}})}},0);module.addFirstRenderOperation(function(){const m=this;const el=module.container.querySelector("[name='"+directive.value+"']");if(el){el.addEventListener("focus",function(e){el.canBeValid=true});el.addEventListener("blur",function(e){Renderer.add(m)})}})},handle:(directive,dom,module,parent)=>{const el=module.container.querySelector("[name='"+directive.value+"']");if(!el||!el.canBeValid){dom.dontRender=true;return}let chds=[];dom.children.forEach(item=>{if(item.tagName!==undefined&&item.props.hasOwnProperty("rel")){chds.push(item)}});let resultArr=[];if(directive.params.method){const foo=module.methodFactory.get(directive.params.method);if(nodom.isFunction(foo)){let r=foo.call(module.model,el.value);if(!r){resultArr.push("custom")}}}let vld=el.validity;if(!vld.valid){for(var o in vld){if(vld[o]===true){resultArr.push(o)}}}if(resultArr.length>0){let vn=handle(resultArr);if(chds.length===0){setTip(dom,vn,el)}else{for(let i=0;i<chds.length;i++){let rel=chds[i].props["rel"];if(rel===vn){setTip(chds[i],vn,el)}else{chds[i].dontRender=true}}}}else{dom.dontRender=true}function setTip(vd,vn,el){let text=vd.children[0].textContent.trim();if(text===""){text=nodom.compileStr(nodom.FormMsgs[vn],el.getAttribute(vn))}vd.children[0].textContent=text}function handle(arr){for(var i=0;i<arr.length;i++){switch(arr[i]){case"valueMissing":return"required";case"typeMismatch":return"type";case"tooLong":return"maxLength";case"tooShort":return"minLength";case"rangeUnderflow":return"min";case"rangeOverflow":return"max";case"patternMismatch":return"pattern";default:return arr[i]}}}}});FilterManager.addType("date",(value,param)=>{if(nodom.isEmpty(value)){return""}param=param.substr(1,param.length-2);return nodom.formatDate(value,param)});FilterManager.addType("currency",(value,sign)=>{if(isNaN(value)){return""}sign=sign||"¥";if(typeof value==="string"){value=parseFloat(value)}return sign+(value*100+.5|0)/100});FilterManager.addType("number",(value,param)=>{let digits=param||0;if(isNaN(value)||digits<0){return""}if(typeof value==="string"){value=parseFloat(value)}let x=1;for(let i=0;i<digits;i++){x*=10}return(value*x+.5|0)/x});FilterManager.addType("tolowercase",value=>{if(nodom.isEmpty(value)){return""}if(!nodom.isString(value)||nodom.isEmpty(value)){throw Error.handle("invoke1",nodom.words.filter+" tolowercase",0,"string")}return value.toLowerCase()});FilterManager.addType("touppercase",value=>{if(nodom.isEmpty(value)){return""}if(!nodom.isString(value)||nodom.isEmpty(value)){throw Error.handle("invoke1",nodom.words.filter+" touppercase",0,"string")}return value.toUpperCase()});FilterManager.addType("orderby",function(){let args=arguments;let arr=args[0];let field=args[1];let odr=args[2]||"asc";if(!nodom.isArray(arr)){throw Error.handle("invoke1",nodom.words.filter+" orderby",0,"array")}let ret=arr.concat([]);if(field&&nodom.isObject(arr[0])){if(odr==="asc"){ret.sort((a,b)=>a[field]>=b[field]?1:-1)}else{ret.sort((a,b)=>b[field]<=a[field]?1:-1)}}else{if(odr==="asc"){ret.sort((a,b)=>a>=b?1:-1)}else{ret.sort((a,b)=>b<=a?1:-1)}}return ret});FilterManager.addType("select",function(){if(!nodom.isArray(arguments[0])){throw Error.handle("invoke1",nodom.words.filter+" filter",0,"array")}let params=new Array;for(let i=0;i<arguments.length;i++){params.push(arguments[i])}let handler={odd:function(){let arr=arguments[0];let ret=[];for(let i=0;i<arr.length;i++){if(i%2===1){ret.push(arr[i])}}return ret},even:function(){let arr=arguments[0];let ret=[];for(let i=0;i<arr.length;i++){if(i%2===0){ret.push(arr[i])}}return ret},range:function(){let args=arguments;let arr=args[0];let ret=[];let first=args[1];let last=args[2];if(isNaN(first)){throw Error.handle("paramException",nodom.words.filter,"filter range")}if(!nodom.isNumber(first)){first=parseInt(first)}if(isNaN(last)){throw Error.handle("paramException",nodom.words.filter,"filter range")}if(!nodom.isNumber(last)){last=parseInt(last)}if(first>last){throw Error.handle("paramException",nodom.words.filter,"filter range")}return arr.slice(first,last+1)},index:function(){let args=arguments;let arr=args[0];if(!nodom.isArray(args[0])){throw Error.handle("paramException",nodom.words.filter,"filter index")}let ret=[];if(arr.length>0){for(let i=1;i<args.length;i++){if(isNaN(args[i])){continue}let k=parseInt(args[i]);if(k<arr.length){ret.push(arr[k])}}}return ret},func:function(arr,param){if(!nodom.isArray(arr)||nodom.isEmpty(param)){throw Error.handle("paramException",nodom.words.filter,"filter func")}let foo=this.methodFactory.get(param);if(nodom.isFunction(foo)){return foo(arr)}return arr},value:function(arr,param){if(!nodom.isArray(arr)||nodom.isEmpty(param)){throw Error.handle("paramException",nodom.words.filter,"filter value")}if(nodom.isObject(param)){let keys=nodom.getOwnProps(param);return arr.filter(function(item){for(let i=0;i<keys.length;i++){let v=item[keys[i]];let v1=param[keys[i]];if(v===undefined||v!==v1&&typeof v==="string"&&v.indexOf(v1)===-1){return false}}return true})}else{return arr.filter(function(item){let props=nodom.getOwnProps(item);for(let i=0;i<props.length;i++){let v=item[props[i]];if(nodom.isString(v)&&v.indexOf(param)!==-1){return item}}})}}};let type;if(nodom.isString(params[1])){type=params[1].trim();if(handler.hasOwnProperty(type)){params.splice(1,1)}else{type="value"}}else{type="value"}if(type==="range"||type==="index"||type==="func"){if(params.length<2){throw Error.handle("paramException",nodom.words.filter)}}return nodom.apply(handler[type],this,params)});FilterManager.addType("html",value=>{if(nodom.isEmpty(value)){return""}let div=nodom.newEl("div");div.innerHTML=value;let frag=document.createDocumentFragment();for(let i=0;i<div.childNodes.length;i++){frag.appendChild(div.childNodes[i])}return frag});Class.add("Directive",Directive);Class.add("Filter",Filter);Class.add("Expression",Expression);Class.add("Element",Element);Class.add("Module",Module);Class.add("Model",Model);Class.add("Event",Event);Class.add("Route",Route);Class.add("DirectiveFactory",DirectiveFactory);Class.add("ExpressionFactory",ExpressionFactory);Class.add("MethodFactory",MethodFactory);Class.add("MessageFactory",MessageFactory);Class.add("ModelFactory",ModelFactory);Class.add("ModuleFactory",ModuleFactory);nodom.createModule=function(config){if(nodom.isArray(config)){config.forEach(item=>{new Module(item)})}else{return new Module(config)}};nodom.createRoute=function(config){if(nodom.isArray(config)){config.forEach(item=>{new Route(item)})}else{return new Route(config)}};