var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value)})}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};var __generator=this&&this.__generator||function(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}};var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var nodom;(function(nodom){function newApp(config){return __awaiter(this,void 0,void 0,function(){var module;return __generator(this,function(_a){switch(_a.label){case 0:if(!config.module){throw new nodom.NodomError("config",nodom.TipWords.application)}if(config.options){nodom.Application.routerPrePath=config.options["routerPrePath"]||"";nodom.Application.templatePath=config.options["templatePath"]||"";nodom.Application.renderTick=config.options["renderTick"]||100}nodom.Scheduler.addTask(nodom.MessageQueue.handleQueue,nodom.MessageQueue);nodom.Scheduler.addTask(nodom.Renderer.render,nodom.Renderer);nodom.Scheduler.start();module=createModule(config.module,true);return[4,module.active()];case 1:_a.sent();return[2,module]}})})}nodom.newApp=newApp;function createModule(config,main){if(nodom.Util.isArray(config)){for(var _i=0,_a=config;_i<_a.length;_i++){var item=_a[_i];new nodom.Module(item)}}else{return new nodom.Module(config,main)}}nodom.createModule=createModule;function createRoute(config){if(nodom.Util.isArray(config)){for(var _i=0,_a=config;_i<_a.length;_i++){var item=_a[_i];new nodom.Route(item)}}else{return new nodom.Route(config)}}nodom.createRoute=createRoute;function createDirective(name,priority,init,handler){return nodom.DirectiveManager.addType(name,{prio:priority,init:init,handler:handler})}nodom.createDirective=createDirective;function createPlugin(name,init,handler){}nodom.createPlugin=createPlugin})(nodom||(nodom={}));var nodom;(function(nodom){var Util=function(){function Util(){}Util.genId=function(){return this.generatedId++};Util.prototype.clone=function(srcObj,expKey){var map=new WeakMap;var retObj=clone(srcObj);map=null;return retObj;function clone(src){var _this=this;var dst;if(this.isObject(src)){dst=new Object;map.set(src,dst);Object.getOwnPropertyNames(src).forEach(function(prop){if(expKey){if(expKey.constructor===RegExp&&expKey.test(prop)||expKey.constructor===String&&expKey===prop){return}}if(_this.isObject(src[prop])||_this.isArray(src[prop])){var co=null;if(!map.has(src[prop])){co=clone(src[prop]);map.set(src[prop],co)}else{co=map.get(src[prop])}dst[prop]=co}else{dst[prop]=src[prop]}})}else if(this.isArray(src)){dst=new Array;map.set(src,dst);src.forEach(function(item,i){if(this.isObject(item)||this.isArray(item)){dst[i]=clone(item)}else{dst[i]=item}})}return dst}};Util.merge=function(){for(var i=0;i<arguments.length;i++){if(!this.isObject(arguments[i])){throw new nodom.NodomError("invoke","this.merge",i+"","object")}}var retObj=Object.assign.apply(null,arguments);subObj(retObj);return retObj;function subObj(retObj){for(var o in retObj){if(this.isObject(retObj[o])||this.isArray(retObj[o])){retObj[o]=retObj[o].clone()}}}};Util.assign=function(obj1,obj2){if(Object.assign){Object.assign(obj1,obj2)}else{this.getOwnProps(obj2).forEach(function(p){obj1[p]=obj2[p]})}return obj1};Util.getOwnProps=function(obj){if(!obj){return[]}return Object.getOwnPropertyNames(obj)};Util.isFunction=function(foo){return foo!==undefined&&foo!==null&&foo.constructor===Function};Util.isArray=function(obj){return Array.isArray(obj)};Util.isObject=function(obj){return obj!==null&&obj!==undefined&&obj.constructor===Object};Util.isInt=function(v){return Number.isInteger(v)};Util.isNumber=function(v){return typeof v==="number"};Util.isBoolean=function(v){return typeof v==="boolean"};Util.isString=function(v){return typeof v==="string"};Util.isNumberString=function(v){return/^\d+\.?\d*$/.test(v)};Util.isEmpty=function(obj){if(obj===null||obj===undefined)return true;var tp=typeof obj;if(this.isObject(obj)){var keys=Object.keys(obj);if(keys!==undefined){return keys.length===0}}else if(tp==="string"){return obj===""}return false};Util.findObjByProps=function(obj,props,one){if(!this.isObject(obj)){throw new nodom.NodomError("invoke","this.findObjByProps","0","Object")}one=one||false;var ps=this.getOwnProps(props);var find=false;if(one===false){find=true;for(var i=0;i<ps.length;i++){var p=ps[i];if(obj[p]!==props[p]){find=false;break}}}else{for(var i=0;i<ps.length;i++){var p=ps[i];if(obj[p]===props[p]){find=true;break}}}if(find){return obj}for(var p in obj){var o=obj[p];if(o!==null){if(this.isObject(o)){var oprops=this.getOwnProps(o);for(var i=0;i<oprops.length;i++){var item=o[oprops[i]];if(item!==null&&this.isObject(item)){var r=this.findObjByProps(item,props,one);if(r!==null){return r}}}}else if(this.isArray(o)){for(var i=0;i<o.length;i++){var item=o[i];if(item!==null&&this.isObject(item)){var r=this.findObjByProps(item,props,one);if(r!==null){return r}}}}}}return null};Util.get=function(selector,findAll,pview){pview=pview||document;if(findAll===true){return pview.querySelectorAll(selector)}return pview.querySelector(selector)};Util.append=function(el,dom){if(this.isNode(dom)){el.appendChild(dom)}else if(this.isString(dom)){var div=this.newEl("div");div.innerHTML=dom}};Util.isEl=function(el){return el instanceof HTMLElement};Util.isNode=function(node){return node!==undefined&&node!==null&&(node.nodeType===Node.TEXT_NODE||node.nodeType===Node.ELEMENT_NODE||node.nodeType===Node.DOCUMENT_FRAGMENT_NODE)};Util.newEl=function(tagName,config,text){if(!this.isString(tagName)||this.isEmpty(tagName)){throw new nodom.NodomError("invoke","this.newEl","0","string")}var el=document.createElement(tagName);if(this.isObject(config)){this.attr(el,config)}else if(this.isString(text)){el.innerHTML=text}return el};Util.newSvgEl=function(tagName){return document.createElementNS("http://www.w3.org/2000/svg",tagName)};Util.replaceNode=function(srcNode,nodes){if(!this.isNode(srcNode)){throw new nodom.NodomError("invoke","this.replaceNode","0","Node")}if(!this.isNode(nodes)&&!this.isArray(nodes)){throw new nodom.NodomError("invoke1","this.replaceNode","1","Node","Node Array")}var pnode=srcNode.parentNode;var bnode=srcNode.nextSibling;if(pnode===null){return}pnode.removeChild(srcNode);var nodeArr=this.isArray(nodes)?nodes:[nodes];nodeArr.forEach(function(node){if(bnode===undefined||bnode===null){pnode.appendChild(node)}else{pnode.insertBefore(node,bnode)}})};Util.insertAfter=function(newNode,srcNode,pNode){if(!this.isNode(newNode)){throw new nodom.NodomError("invoke","this.insertAfter","0","Node")}if(!this.isNode(srcNode)&&!this.isNode(pNode)){throw new nodom.NodomError("invoke2","this.insertAfter","1","2","Node")}var bNode=null;if(srcNode===undefined||srcNode===null){bNode=pNode.firstChild}else{pNode=srcNode.parentNode;bNode=srcNode.nextSibling}if(!this.isNode(pNode)){return}if(bNode===null){if(this.isArray(newNode)){for(var _i=0,_a=newNode;_i<_a.length;_i++){var n=_a[_i];if(this.isEl(n)){pNode.appendChild(n)}}}else{pNode.appendChild(newNode)}}else{if(this.isArray(newNode)){for(var _b=0,_c=newNode;_b<_c.length;_b++){var n=_c[_b];if(this.isEl(n)){pNode.insertBefore(n,bNode)}}}else{pNode.insertBefore(newNode,bNode)}}};Util.empty=function(el){var me=this;if(!me.isEl(el)){throw new nodom.NodomError("invoke","this.empty","0","Element")}var nodes=el.childNodes;for(var i=nodes.length-1;i>=0;i--){el.removeChild(nodes[i])}};Util.remove=function(node){var me=this;if(!me.isNode(node)){throw new nodom.NodomError("invoke","this.remove","0","Node")}if(node.parentNode!==null){node.parentNode.removeChild(node)}};Util.attr=function(el,param,value){var me=this;if(!me.isEl(el)){throw new nodom.NodomError("invoke","this.attr","0","Element")}if(this.isEmpty(param)){throw new nodom.NodomError("invoke","this.attr","1","string","object")}if(value===undefined||value===null){if(this.isObject(param)){this.getOwnProps(param).forEach(function(k){if(k==="value"){el[k]=param[k]}else{el.setAttribute(k,param[k])}})}else if(this.isString(param)){if(param==="value"){return param[value]}return el.getAttribute(param)}}else{if(param==="value"){el[param]=value}else{el.setAttribute(param,value)}}};Util.width=function(el,value){if(!this.isEl(el)){throw new nodom.NodomError("invoke","nodom.width","0","Element")}if(this.isNumber(value)){el.style.width=value+"px"}else{var compStyle=void 0;if(window.getComputedStyle){compStyle=window.getComputedStyle(el,null)}if(!compStyle){return null}var w=parseInt(compStyle["width"]);if(value===true){var pw=parseInt(compStyle["paddingLeft"])+parseInt(compStyle["paddingRight"]);w-=pw}return w}};Util.height=function(el,value){if(!this.isEl(el)){throw new nodom.NodomError("invoke","this.height","0","Element")}if(this.isNumber(value)){el.style.height=value+"px"}else{var compStyle=void 0;if(window.getComputedStyle){compStyle=window.getComputedStyle(el,null)}if(!compStyle){return null}var w=parseInt(compStyle["height"]);if(value===true){var pw=parseInt(compStyle["paddingTop"])+parseInt(compStyle["paddingBottom"]);w-=pw}return w}};Util.formatDate=function(srcDate,format){var timeStamp;if(this.isString(srcDate)){var reg=new RegExp(/^\d+$/);if(reg.test(srcDate)===true){timeStamp=parseInt(srcDate)}}else if(this.isNumber(srcDate)){timeStamp=srcDate}else{throw new nodom.NodomError("invoke","this.formatDate","0","date string","date")}var date=new Date(timeStamp);if(isNaN(date.getDay())){return""}var o={"M+":date.getMonth()+1,"d+":date.getDate(),"h+":date.getHours()%12===0?12:date.getHours()%12,"H+":date.getHours(),"m+":date.getMinutes(),"s+":date.getSeconds(),"q+":Math.floor((date.getMonth()+3)/3),S:date.getMilliseconds()};var week={0:"日",1:"一",2:"二",3:"三",4:"四",5:"五",6:"六"};if(/(y+)/.test(format)){format=format.replace(RegExp.$1,(date.getFullYear()+"").substr(4-RegExp.$1.length))}this.getOwnProps(o).forEach(function(k){if(new RegExp("("+k+")").test(format)){format=format.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+o[k]).substr((""+o[k]).length))}});if(/(E+)/.test(format)){format=format.replace(RegExp.$1,(RegExp.$1.length>1?RegExp.$1.length>2?"/u661f/u671f":"/u5468":"")+week[date.getDay()+""])}return format};Util.compileStr=function(src,p1,p2,p3,p4,p5){var reg;var args=arguments;var index=0;for(;;){if(src.indexOf("{"+index+"}")!==-1){reg=new RegExp("\\{"+index+"\\}","g");src=src.replace(reg,args[index+1]);index++}else{break}}return src};Util.apply=function(foo,obj,args){if(!foo){return}return Reflect.apply(foo,obj||null,args)};Util.generatedId=1;return Util}();nodom.Util=Util})(nodom||(nodom={}));var nodom;(function(nodom){var Application=function(){function Application(){}return Application}();nodom.Application=Application})(nodom||(nodom={}));var nodom;(function(nodom){var Factory=function(){function Factory(module){if(module!==undefined){this.moduleName=module.name}this.items=Object.create(null)}Factory.prototype.add=function(name,item){this.items[name]=item};Factory.prototype.get=function(name){return this.items[name]};Factory.prototype.remove=function(name){delete this.items[name]};return Factory}();nodom.Factory=Factory})(nodom||(nodom={}));var nodom;(function(nodom){var Compiler=function(){function Compiler(){}Compiler.compile=function(module,elementStr){var div=nodom.Util.newEl("div");div.innerHTML=elementStr;var oe=new nodom.Element;oe.root=true;for(var i=0;i<div.childNodes.length;i++){this.compileDom(module,div.childNodes[i],oe)}return oe};Compiler.compileDom=function(module,ele,parent){var me=this;var oe=new nodom.Element;var isComment=false;switch(ele.nodeType){case Node.ELEMENT_NODE:var el=ele;oe.tagName=el.tagName;for(var i=0;i<el.attributes.length;i++){var attr=el.attributes[i];var v=attr.value.trim();if(attr.name.startsWith("x-")){oe.directives.push(new nodom.Directive(attr.name.substr(2),v,oe,module,el))}else if(attr.name.startsWith("e-")){var en=attr.name.substr(2);oe.events[en]=new nodom.NodomEvent(en,attr.value.trim())}else{var isExpr=false;if(v!==""){var ra=me.compileExpression(module,v);if(nodom.Util.isArray(ra)){oe.exprProps[attr.name]=ra;isExpr=true}}if(!isExpr){oe.props[attr.name]=v}}}var subEls_1=[];ele.childNodes.forEach(function(nd){subEls_1.push(me.compileDom(module,nd,oe))});oe.directives.sort(function(a,b){return nodom.DirectiveManager.getType(a.type).prio-nodom.DirectiveManager.getType(b.type).prio});break;case Node.TEXT_NODE:var txt=ele.textContent;if(txt===""){return}var expA=me.compileExpression(module,txt);if(typeof expA==="string"){oe.textContent=expA}else{oe.expressions=expA}break;case Node.COMMENT_NODE:isComment=true;break}if(!isComment&&parent){parent.children.push(oe)}return oe};Compiler.compileExpression=function(module,exprStr){if(/\{\{.+?\}\}/.test(exprStr)===false){return exprStr}var reg=/\{\{.+?\}\}/g;var retA=new Array;var re;var oIndex=0;while((re=reg.exec(exprStr))!==null){var ind=re.index;if(ind>oIndex){var s=exprStr.substring(oIndex,ind);retA.push(s)}var exp=new nodom.Expression(re[0].substring(2,re[0].length-2),module);module.expressionFactory.add(exp.id,exp);retA.push(exp.id);oIndex=ind+re[0].length}if(oIndex<exprStr.length-1){retA.push(exprStr.substr(oIndex))}return retA};return Compiler}();nodom.Compiler=Compiler})(nodom||(nodom={}));var nodom;(function(nodom){var Directive=function(){function Directive(type,value,vdom,module,el){this.id=nodom.Util.genId();this.type=type;if(nodom.Util.isString(value)){this.value=value.trim()}if(type!==undefined){nodom.Util.apply(nodom.DirectiveManager.init,nodom.DirectiveManager,[this,vdom,module,el])}}Directive.prototype.exec=function(value){var args=[this.module,this.type,value];return nodom.Util.apply(nodom.DirectiveManager.exec,nodom.DirectiveManager,args)};return Directive}();nodom.Directive=Directive})(nodom||(nodom={}));var nodom;(function(nodom){var DirectiveFactory=function(_super){__extends(DirectiveFactory,_super);function DirectiveFactory(){return _super!==null&&_super.apply(this,arguments)||this}return DirectiveFactory}(nodom.Factory);nodom.DirectiveFactory=DirectiveFactory})(nodom||(nodom={}));var nodom;(function(nodom){var DirectiveManager=function(){function DirectiveManager(){}DirectiveManager.addType=function(name,config,replacable){if(this.directiveTypes.has(name)){throw new nodom.NodomError("exist1",nodom.TipWords.directiveType,name)}if(!nodom.Util.isObject(config)){throw new nodom.NodomError("invoke","DirectiveManager.addType","1","Function")}config.prio=config.prio||10;if(replacable&&!this.cantEditTypes.includes(name)){this.cantEditTypes.push(name)}this.directiveTypes.set(name,config)};DirectiveManager.removeType=function(name){if(this.cantEditTypes.indexOf(name)!==-1){throw new nodom.NodomError("notupd",nodom.TipWords.system+nodom.TipWords.directiveType,name)}if(!this.directiveTypes.has(name)){throw new nodom.NodomError("notexist1",nodom.TipWords.directiveType,name)}this.directiveTypes.delete(name)};DirectiveManager.getType=function(name){return this.directiveTypes.get(name)};DirectiveManager.hasType=function(name){return this.directiveTypes.has(name)};DirectiveManager.init=function(directive,dom,module,el){var dt=this.directiveTypes.get(directive.type);if(dt===undefined){throw new nodom.NodomError("notexist1",nodom.TipWords.directiveType,name)}return dt.init(directive,dom,module,el)};DirectiveManager.exec=function(directive,dom,module,parent){if(!this.directiveTypes.has(directive.type)){throw new nodom.NodomError("notexist1",nodom.TipWords.directiveType,directive.type)}return nodom.Util.apply(this.directiveTypes.get(directive.type).handle,null,[directive,dom,module,parent])};DirectiveManager.directiveTypes=new Map;DirectiveManager.cantEditTypes=["model","repeat","if","else","show","class","field"];return DirectiveManager}();nodom.DirectiveManager=DirectiveManager})(nodom||(nodom={}));var nodom;(function(nodom){var ChangedDom=function(){function ChangedDom(node,type,parent,index){this.node=node;this.type=type;this.parent=parent;this.index=index}return ChangedDom}();nodom.ChangedDom=ChangedDom;var Element=function(){function Element(tag){this.directives=[];this.props={};this.exprProps={};this.events={};this.expressions=[];this.children=[];this.dontRender=false;this.tagName=tag;this.key=nodom.Util.genId()+""}Element.prototype.render=function(module,parent){if(parent){this.parentKey=parent.key;if(!this.modelId){this.modelId=parent.modelId}}if(this.tagName!==undefined){this.handleProps(module);this.handleDirectives(module,parent)}else{this.handleTextContent(module)}if(!this.dontRender){for(var i=0;i<this.children.length;i++){var item=this.children[i];item.render(module,this);if(item.dontRender){this.removeChild(item);i--}}}return true};Element.prototype.renderToHtml=function(module,params){var el;var el1;var type=params.type;var parent=params.parent;if(!parent){el=module.container}else{if(type==="fresh"||type==="add"||type==="text"){el=module.container.querySelector("[key='"+parent.key+"']")}else if(this.tagName!==undefined){el=module.container.querySelector("[key='"+this.key+"']")}}if(!el){return}switch(type){case"fresh":if(this.tagName){el1=newEl(this,null,el);genSub(el1,this)}else{el1=newText(this.textContent,this)}el.appendChild(el1);break;case"text":if(!parent||!parent.children){break}var ind=parent.children.indexOf(this);if(ind!==-1){if(this.type==="html"){var div=document.querySelector("[key='"+this.key+"']");if(div!==null){div.innerHTML="";div.appendChild(this.textContent)}else{var div_1=newText(this.textContent);nodom.Util.replaceNode(el.childNodes[ind],div_1)}}else{el.childNodes[ind].textContent=this.textContent}}break;case"upd":if(params.removeProps){params.removeProps.forEach(function(p){el.removeAttribute(p)})}if(params.changeProps){params.changeProps.forEach(function(p){if(el.tagName==="INPUT"&&p.k==="value"){el.value=p.v}else{el.setAttribute(p.k,p.v)}})}break;case"rep":el1=newEl(this,parent);nodom.Util.replaceNode(el,el1);break;case"add":if(this.tagName){el1=newEl(this,parent,el);genSub(el1,this)}else{el1=newText(this.textContent)}if(params.index===el.childNodes.length){el.appendChild(el1)}else{el.insertBefore(el1,el.childNodes[params.index])}}function newEl(vdom,parent,parentEl){var el=document.createElement(vdom.tagName);nodom.Util.getOwnProps(vdom.props).forEach(function(k){el.setAttribute(k,vdom.props[k])});el.setAttribute("key",vdom.key);vdom.handleEvents(module,el,parent,parentEl);return el}function newText(text,dom){if(dom&&"html"===dom.type){var div=nodom.Util.newEl("div");div.setAttribute("key",dom.key);div.appendChild(text);return div}else{return document.createTextNode(text)}}function genSub(pEl,vNode){if(vNode.children&&vNode.children.length>0){vNode.children.forEach(function(item){var el1;if(item.tagName){el1=newEl(item,vNode,pEl);genSub(el1,item)}else{el1=newText(item.textContent,item)}pEl.appendChild(el1)})}}};Element.prototype.clone=function(){var _this=this;var dst=new Element;nodom.Util.getOwnProps(this).forEach(function(p){if(typeof _this[p]!=="object"){dst[p]=_this[p]}});for(var _i=0,_a=this.directives;_i<_a.length;_i++){var d=_a[_i];dst.directives.push(d)}nodom.Util.getOwnProps(this.props).forEach(function(k){dst.props[k]=_this.props[k]});nodom.Util.getOwnProps(this.exprProps).forEach(function(k){dst.exprProps[k]=_this.exprProps[k]});nodom.Util.getOwnProps(this.events).forEach(function(k){dst.events[k]=_this.events[k].clone()});dst.expressions=this.expressions;this.children.forEach(function(d){dst.children.push(d.clone())});return dst};Element.prototype.handleDirectives=function(module,parent){if(this.dontRender){return false}var dirs=this.directives;for(var i=0;i<dirs.length&&!this.dontRender;i++){nodom.DirectiveManager.exec(dirs[i],this,module,parent)}return true};Element.prototype.handleExpression=function(exprArr,module){var _this=this;if(this.dontRender){return}var value="";var model=module.modelFactory.get(this.modelId);exprArr.forEach(function(v){if(typeof v==="number"){var v1=module.expressionFactory.get(v).val(model);if(v1 instanceof DocumentFragment||nodom.Util.isEl(v1)){_this.type="html";return v1}value+=v1}else{value+=v}});return value};Element.prototype.handleProps=function(module){var _this=this;if(this.dontRender){return}nodom.Util.getOwnProps(this.exprProps).forEach(function(k){if(nodom.Util.isArray(_this.exprProps[k])){_this.props[k]=_this.handleExpression(_this.exprProps[k],module)}else if(_this.exprProps[k]instanceof nodom.Expression){_this.props[k]=_this.exprProps[k].val(module.modelFactory.get(_this.modelId))}})};Element.prototype.handleTextContent=function(module){if(this.dontRender){return}if(this.expressions!==undefined&&this.expressions.length>0){this.textContent=this.handleExpression(this.expressions,module)}};Element.prototype.handleEvents=function(module,el,parent,parentEl){var _this=this;if(nodom.Util.isEmpty(this.events)){return}nodom.Util.getOwnProps(this.events).forEach(function(k){var ev=_this.events[k];if(ev.delg&&parent){ev.delegateTo(module,_this,el,parent,parentEl)}else{ev.bind(module,_this,el)}})};Element.prototype.removeDirectives=function(delDirectives){for(var i=this.directives.length-1;i>=0;i--){var d=this.directives[i];for(var j=0;j<delDirectives.length;j++){if(d.type===delDirectives[j]){this.directives.splice(i,1)}}}};Element.prototype.hasDirective=function(directiveType){for(var i=0;i<this.directives.length;i++){if(this.directives[i].type===directiveType){return true}}return false};Element.prototype.getDirective=function(directiveType){for(var i=0;i<this.directives.length;i++){if(this.directives[i].type===directiveType){return this.directives[i]}}};Element.prototype.add=function(dom){this.children.push(dom)};Element.prototype.remove=function(module,delHtml){if(this.parentKey!==undefined){var p=module.renderTree.query(this.parentKey);if(p){p.removeChild(this)}}if(delHtml&&module&&module.container){var el=module.container.querySelector("[key='"+this.key+"']");if(el!==null){nodom.Util.remove(el)}}};Element.prototype.removeFromHtml=function(module){var el=module.container.querySelector("[key='"+this.key+"']");if(el!==null){nodom.Util.remove(el)}};Element.prototype.removeChild=function(dom){var ind;if(nodom.Util.isArray(this.children)&&(ind=this.children.indexOf(dom))!==-1){this.children.splice(ind,1)}};Element.prototype.replace=function(dst){if(!dst.parent){return false}var ind=dst.parent.children.indexOf(dst);if(ind===-1){return false}dst.parent.children.splice(ind,1,this);return true};Element.prototype.contains=function(dom){for(;dom!==undefined&&dom!==this;dom=dom.parent);return dom!==undefined};Element.prototype.query=function(key){if(this.key===key){return this}for(var i=0;i<this.children.length;i++){var dom=this.children[i].query(key);if(dom){return dom}}};Element.prototype.compare=function(dst,retArr,parentNode){var _this=this;if(!dst){return}var re=new ChangedDom;var change=false;if(this.tagName===undefined){if(dst.tagName===undefined){if(this.textContent!==dst.textContent){re.type="text";change=true}}else{re.type="rep";change=true}}else{if(this.tagName!==dst.tagName){re.type="rep";change=true}else{re.changeProps=[];re.removeProps=[];nodom.Util.getOwnProps(dst.props).forEach(function(k){if(!_this.props[k]){re.removeProps.push(k)}});nodom.Util.getOwnProps(this.props).forEach(function(k){var v1=dst.props[k];if(_this.props[k]!==v1){re.changeProps.push({k:k,v:_this.props[k]})}});if(re.changeProps.length>0||re.removeProps.length>0){change=true;re.type="upd"}}}if(change){re.node=this;if(parentNode){re.parent=parentNode}retArr.push(re)}if(!this.children||this.children.length===0){if(dst.children&&dst.children.length>0){dst.children.forEach(function(item){retArr.push(new ChangedDom(item,"del"))})}}else{if(!dst.children||dst.children.length===0){this.children.forEach(function(item){retArr.push(new ChangedDom(item,"add",_this))})}else{this.children.forEach(function(dom1,ind){var dom2=dst.children[ind];if(!dom2||dom1.key!==dom2.key){dom2=undefined;for(var i=0;i<dst.children.length;i++){if(dom1.key===dst.children[i].key){dom2=dst.children[i];break}}}if(dom2!==undefined){dom1.compare(dom2,retArr,_this);dom2.finded=true}else{retArr.push(new ChangedDom(dom1,"add",_this,ind))}});if(dst.children&&dst.children.length>0){dst.children.forEach(function(item){if(!item.finded){retArr.push(new ChangedDom(item,"del",dst))}})}}}};return Element}();nodom.Element=Element})(nodom||(nodom={}));var nodom;(function(nodom){var Expression=function(){function Expression(exprStr,module){this.modelMap={};this.replaceMap=new Map;this.fields=[];this.id=nodom.Util.genId();if(module){this.moduleName=module.name;module.expressionFactory.add(this.id,this)}if(exprStr){this.execString=this.compile(exprStr)}if(this.execString){var v=this.fields.length>0?","+this.fields.join(","):"";this.execFunc=eval("(function($module"+v+"){return "+this.execString+"})")}}Expression.prototype.compile=function(exprStr){var stringReg=[/\".*?\"/,/'.*?'/,/`.*?`/];var quotReg=[/\\"/g,/\\'/g,/\\`/g];var quotStr=["$$$$NODOM_QUOT1","$$$$NODOM_QUOT2","$$$$NODOM_QUOT3"];var srcStr=exprStr;var replaceIndex=0;for(var i=0;i<3;i++){srcStr=srcStr.replace(quotReg[i],quotStr[i])}for(;;){var r=void 0;for(var _i=0,stringReg_1=stringReg;_i<stringReg_1.length;_i++){var reg=stringReg_1[_i];var r1=reg.exec(srcStr);if(!r1){continue}if(!r||r.index>r1.index){r=r1}}if(!r){break}var sTmp=Expression.REP_STR+replaceIndex++;this.replaceMap.set(sTmp,r[0]);srcStr=srcStr.substr(0,r.index)+sTmp+srcStr.substr(r.index+r[0].length)}srcStr=srcStr.replace(/\s+/g,"");var arrOperator=srcStr.split(/[\(\)\!\|\*\/\+\-><=&%]/);var arrOperand=[];var index=0;for(var _a=0,arrOperator_1=arrOperator;_a<arrOperator_1.length;_a++){var sp=arrOperator_1[_a];index+=sp.length;var ch=srcStr.charAt(index++);if(ch!==""){arrOperand.push(ch)}}return this.genExecStr(arrOperator,arrOperand)};Expression.prototype.genExecStr=function(arrOperator,arrOperand){var retStr="";for(;arrOperator.length>1;){var opr=arrOperator.pop();var opd=arrOperand.pop();var r=void 0;var handled=false;if(opd==="("){r=this.judgeAndHandleFunc(arrOperator,arrOperand,opr);if(r!==undefined){if(r.startsWith("$module")){retStr=r+retStr.substr(1)}else if(opr!==""){if(!this.addField(opr)){opr=this.recoveryString(opr)}retStr=r+opd+opr+retStr}if(arrOperand.length>0){retStr=arrOperand.pop()+retStr}handled=true}}else if(opd==="|"){r=this.judgeAndHandleFilter(arrOperator,arrOperand,opr);if(r!==undefined){retStr=(arrOperand.length>0?arrOperand.pop():"")+r+retStr;handled=true}}if(!handled){if(!this.addField(opr)){opr=this.recoveryString(opr)}retStr=opd+opr+retStr}}if(arrOperator.length>0){var opr=arrOperator.pop();if(opr!==""){if(!this.addField(opr)){opr=this.recoveryString(opr)}retStr=opr+retStr}}return retStr};Expression.prototype.recoveryString=function(str){if(str.startsWith(Expression.REP_STR)){if(this.replaceMap.has(str)){str=this.replaceMap.get(str);str=str.replace(/\$\$NODOM_QUOT1/g,'\\"');str=str.replace(/\$\$NODOM_QUOT2/g,"\\'");str=str.replace(/\$\$NODOM_QUOT3/g,"\\`")}}return str};Expression.prototype.judgeAndHandleFunc=function(arrOperator,arrOperand,srcOp){var sp=arrOperator[arrOperator.length-1];if(sp&&sp!==""){arrOperator.pop();if(sp.startsWith("$")){return'$module.methodFactory.get("'+sp.substr(1)+'").apply($module)'}else{return sp}}};Expression.prototype.judgeAndHandleFilter=function(arrOperator,arrOperand,srcOp){var _this=this;if(srcOp.startsWith(Expression.REP_STR)||nodom.Util.isNumberString(srcOp)){return}var sa=nodom.FilterManager.explain(srcOp);if(sa.length>1||nodom.FilterManager.hasType(sa[0])){var ftype=sa[0];sa.shift();sa.forEach(function(v,i){v=_this.recoveryString(v);if(!nodom.Util.isNumberString(v)){sa[i]='"'+v+'"'}});var paramStr=sa.length>0?","+sa.join(","):"";var filterValue="";var opr=arrOperator[arrOperator.length-1];if(opr!==""){if(!this.addField(opr)){opr=this.recoveryString(opr)}filterValue=opr;arrOperator.pop()}else if(arrOperand.length>2&&arrOperand[arrOperand.length-1]===")"){var quotNum=1;var a1=[arrOperator.pop()];var a2=[arrOperand.pop()];for(var i=arrOperand.length-1;i>=0;i--){if(arrOperand[i]==="("){quotNum--}else if(arrOperand[i]===")"){quotNum++}a1.unshift(arrOperator.pop());a2.unshift(arrOperand.pop());if(quotNum===0){a1.unshift(arrOperator.pop());break}}filterValue=this.genExecStr(a1,a2)}return'nodom.FilterManager.exec($module,"'+ftype+'",'+filterValue+paramStr+")"}};Expression.prototype.val=function(model){if(!model){return""}var module=nodom.ModuleFactory.get(model.moduleName);var fieldObj=model.data;var valueArr=[];this.fields.forEach(function(field){valueArr.push(fieldObj[field])});valueArr.unshift(module);return this.execFunc.apply(null,valueArr)};Expression.prototype.addField=function(field){if(field===""||field.startsWith(Expression.REP_STR)||nodom.Util.isNumberString(field)){return false}var ind;if((ind=field.indexOf("."))!==-1){field=field.substr(0,ind)}if(!this.fields.includes(field)){this.fields.push(field)}return true};Expression.REP_STR="$$NODOM_TMPSTR";return Expression}();nodom.Expression=Expression})(nodom||(nodom={}));var nodom;(function(nodom){var ExpressionFactory=function(_super){__extends(ExpressionFactory,_super);function ExpressionFactory(){return _super!==null&&_super.apply(this,arguments)||this}return ExpressionFactory}(nodom.Factory);nodom.ExpressionFactory=ExpressionFactory})(nodom||(nodom={}));var nodom;(function(nodom){var Filter=function(){function Filter(src){var arr=nodom.Util.isString(src)?nodom.FilterManager.explain(src):src;if(arr){this.type=arr[0];this.params=arr.slice(1)}}Filter.prototype.exec=function(value,module){var args=[module,this.type,value].concat(this.params);return nodom.Util.apply(nodom.FilterManager.exec,module,args)};return Filter}();nodom.Filter=Filter})(nodom||(nodom={}));var nodom;(function(nodom){var FilterFactory=function(_super){__extends(FilterFactory,_super);function FilterFactory(){return _super!==null&&_super.apply(this,arguments)||this}return FilterFactory}(nodom.Factory);nodom.FilterFactory=FilterFactory})(nodom||(nodom={}));var nodom;(function(nodom){var FilterManager=function(){function FilterManager(){}FilterManager.addType=function(name,handler){if(!/^[a-zA-Z]+$/.test(name)){throw new nodom.NodomError("namedinvalid",nodom.TipWords.filterType,name)}if(this.filterTypes.has(name)){throw new nodom.NodomError("exist1",nodom.TipWords.filterType,name)}if(!nodom.Util.isFunction(handler)){throw new nodom.NodomError("invoke","FilterManager.addType","1","Function")}this.filterTypes.set(name,handler)};FilterManager.removeType=function(name){if(this.cantEditTypes.indexOf(name)!==-1){throw new nodom.NodomError("notupd",nodom.TipWords.system+nodom.TipWords.filterType,name)}if(!this.filterTypes.has(name)){throw new nodom.NodomError("notexist1",nodom.TipWords.filterType,name)}this.filterTypes.delete(name)};FilterManager.hasType=function(name){return this.filterTypes.has(name)};FilterManager.exec=function(module,type){var params=new Array;for(var i=2;i<arguments.length;i++){params.push(arguments[i])}if(!FilterManager.filterTypes.has(type)){throw new nodom.NodomError("notexist1",nodom.TipWords.filterType,type)}return nodom.Util.apply(FilterManager.filterTypes.get(type),module,params)};FilterManager.explain=function(src){var startStr;var startObj=false;var strings="\"'`";var splitCh=":";var retArr=new Array;var tmp="";for(var i=0;i<src.length;i++){var ch=src[i];if(strings.indexOf(ch)!==-1){if(ch===startStr){startStr=undefined}else{startStr=ch}}else if(startStr===undefined){if(ch==="}"&&startObj){startObj=false}else if(ch==="{"){startObj=true}}if(ch===splitCh&&startStr===undefined&&!startObj&&tmp!==""){retArr.push(handleObj(tmp));tmp="";continue}tmp+=ch}if(tmp!==""){retArr.push(handleObj(tmp))}return retArr;function handleObj(s){s=s.trim();if(s.charAt(0)==="{"){s=eval("("+s+")")}return s}};FilterManager.filterTypes=new Map;FilterManager.cantEditTypes=["date","currency","number","tolowercase","touppercase","orderBy","filter"];return FilterManager}();nodom.FilterManager=FilterManager})(nodom||(nodom={}));var nodom;(function(nodom){var Linker=function(){function Linker(){}Linker.gen=function(type,config){var p;switch(type){case"ajax":p=this.ajax(config);break;case"getfiles":p=this.getfiles(config);break;case"dolist":if(config.params){p=this.dolist(config.funcs,config.params)}else{p=this.dolist(config.funcs)}}return p};Linker.ajax=function(config){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,new Promise(function(resolve,reject){if(config.rand){config.params=config.params||{};config.params.$rand=Math.random()}var url=config.url;var async=config.async===false?false:true;var req=new XMLHttpRequest;req.withCredentials=config.withCredentials;var reqType=config.reqType||"GET";req.timeout=async?config.timeout:0;req.onload=function(){if(req.status===200){var r=req.responseText;if(config.type==="json"){try{r=JSON.parse(r)}catch(e){reject({type:"jsonparse"})}}resolve(r)}else{reject({type:"error",url:url})}};req.ontimeout=function(){return reject({type:"timeout"})};req.onerror=function(){return reject({type:"error",url:url})};switch(reqType){case"GET":var pa=void 0;if(nodom.Util.isObject(config.params)){var ar_1=[];nodom.Util.getOwnProps(config.params).forEach(function(key){ar_1.push(key+"="+config.params[key])});pa=ar_1.join("&")}if(pa!==undefined){if(url.indexOf("?")!==-1){url+="&"+pa}else{url+="?"+pa}}req.open(reqType,url,async,config.user,config.pwd);req.send(null);break;case"POST":var fd=new FormData;for(var o in config.params){fd.append(o,config.params[o])}req.open(reqType,url,async,config.user,config.pwd);req.send(fd);break}}).catch(function(re){switch(re.type){case"error":throw new nodom.NodomError("notexist1",nodom.TipWords.resource,re.url);case"timeout":throw new nodom.NodomError("timeout");case"jsonparse":throw new nodom.NodomError("jsonparse")}})]})})};Linker.getfiles=function(urls){return __awaiter(this,void 0,void 0,function(){var promises;return __generator(this,function(_a){promises=[];urls.forEach(function(url){promises.push(new Promise(function(resolve,reject){var req=new XMLHttpRequest;req.onload=function(){return resolve(req.responseText)};req.onerror=function(){return reject(url)};req.open("GET",url);req.send()}))});return[2,Promise.all(promises).catch(function(text){throw new nodom.NodomError("notexist1",nodom.TipWords.resource,text)})]})})};Linker.dolist=function(funcArr,paramArr){return foo(funcArr,0,paramArr);function foo(fa,i,pa){if(fa.length===0){return Promise.resolve()}else{return new Promise(function(resolve,reject){if(nodom.Util.isArray(pa)){fa[i](resolve,reject,pa[i])}else{fa[i](resolve,reject)}}).then(function(){if(i<fa.length-1){return foo(fa,i+1,pa)}})}}};return Linker}();nodom.Linker=Linker})(nodom||(nodom={}));var nodom;(function(nodom){var Message=function(){function Message(fromModule,toModule,content){this.fromModule=fromModule;this.toModule=toModule;this.content=content;this.readed=false}return Message}();nodom.Message=Message;var MessageQueue=function(){function MessageQueue(){}MessageQueue.add=function(from,to,data){this.messages.push(new Message(from,to,data))};MessageQueue.handleQueue=function(){for(var i=0;i<this.messages.length;i++){var msg=this.messages[i];var module_1=nodom.ModuleFactory.get(msg.toModule);if(module_1&&module_1.state===2||module_1.state===3){module_1.receive(msg.fromModule,msg.content)}if(module_1&&module_1.state>=2){MessageQueue.messages.splice(i--,1)}}};MessageQueue.messages=[];return MessageQueue}();nodom.MessageQueue=MessageQueue})(nodom||(nodom={}));var nodom;(function(nodom){var MethodFactory=function(_super){__extends(MethodFactory,_super);function MethodFactory(){return _super!==null&&_super.apply(this,arguments)||this}MethodFactory.prototype.invoke=function(name,params){var foo=this.get(name);if(!nodom.Util.isFunction(foo)){throw new nodom.NodomError(nodom.ErrorMsgs.notexist1,nodom.TipWords.method,name)}return nodom.Util.apply(foo,this.module.model,params)};return MethodFactory}(nodom.Factory);nodom.MethodFactory=MethodFactory})(nodom||(nodom={}));var nodom;(function(nodom){var Model=function(){function Model(data,module){this.fields={};this.data=data;this.fields={};this.id=nodom.Util.genId();if(module){this.moduleName=module.name;if(module.modelFactory){module.modelFactory.add(this.id+"",this)}}data["$modelId"]=this.id;this.addSetterGetter(data)}Model.prototype.set=function(key,value){var fn,data;var index=key.lastIndexOf(".");if(index!==-1){fn=key.substr(index+1);key=key.substr(0,index);data=this.query(key)}else{fn=key;data=this.data}if(data===undefined){throw new nodom.NodomError("notexist1",nodom.TipWords.dataItem,key)}if(data[fn]!==value){var module_2=nodom.ModuleFactory.get(this.moduleName);if(nodom.Util.isObject(value)||nodom.Util.isArray(value)){new Model(value,module_2)}var model=module_2.modelFactory.get(data.$modelId);if(model){if(data[fn]===undefined){this.defineProp(data,fn)}model.update(fn,value)}data[fn]=value}};Model.prototype.update=function(field,value){var change=false;if(nodom.Util.isString(field)){if(this.fields[field]!==value){this.fields[field]=value;change=true}}if(change){nodom.ModuleFactory.get(this.moduleName).dataChange()}};Model.prototype.addSetterGetter=function(data){var _this=this;if(nodom.Util.isObject(data)){nodom.Util.getOwnProps(data).forEach(function(p){var v=data[p];if(nodom.Util.isObject(v)||nodom.Util.isArray(v)){new Model(v,nodom.ModuleFactory.get(_this.moduleName))}else{_this.update(p,v);_this.defineProp(data,p)}})}else if(nodom.Util.isArray(data)){var watcher=["push","unshift","splice","pop","shift","reverse","sort"];var module_3=nodom.ModuleFactory.get(this.moduleName);watcher.forEach(function(item){data[item]=function(){var args=[];switch(item){case"push":for(var i=0;i<arguments.length;i++){args.push(arguments[i])}break;case"unshift":for(var i=0;i<arguments.length;i++){args.push(arguments[i])}break;case"splice":if(arguments.length>2){for(var i=2;i<arguments.length;i++){args.push(arguments[i])}}break;case"pop":break;case"shift":break}_this.update(data);Array.prototype[item].apply(data,arguments);args.forEach(function(arg){if(nodom.Util.isObject(arg)||nodom.Util.isArray(arg)){new Model(arg,nodom.ModuleFactory.get(_this.moduleName))}})}});data.forEach(function(item){if(nodom.Util.isObject(item)||nodom.Util.isArray(item)){new Model(item,nodom.ModuleFactory.get(_this.moduleName))}})}};Model.prototype.defineProp=function(data,p){var _this=this;Object.defineProperty(data,p,{set:function(v){if(_this.fields[p]===v){return}_this.update(p,v);data[p]=v},get:function(){if(_this.fields[p]!==undefined){return _this.fields[p]}}})};Model.prototype.query=function(name){var data=this.data;var fa=name.split(".");for(var i=0;i<fa.length&&null!==data&&typeof data==="object";i++){if(data===undefined){return}if(fa[i].charAt(fa[i].length-1)==="]"){var f=fa[i].split("[");data=data[f[0]];f.shift();f.forEach(function(istr){var ind=istr.substr(0,istr.length-1);data=data[parseInt(ind)]})}else{data=data[fa[i]]}}return data};return Model}();nodom.Model=Model})(nodom||(nodom={}));var nodom;(function(nodom){var ModelFactory=function(_super){__extends(ModelFactory,_super);function ModelFactory(){return _super!==null&&_super.apply(this,arguments)||this}return ModelFactory}(nodom.Factory);nodom.ModelFactory=ModelFactory})(nodom||(nodom={}));var nodom;(function(nodom){var Module=function(){function Module(config,main){var _this=this;this.firstRender=true;this.children=[];this.firstRenderOps=[];this.beforeFirstRenderOps=[];this.state=0;this.loadNewData=false;this.renderDoms=[];if(config.name){this.name=config.name}else{this.name="Module"+nodom.Util.genId()}nodom.ModuleFactory.add(this.name,this);this.methodFactory=new nodom.MethodFactory(this);this.modelFactory=new nodom.ModelFactory(this);this.expressionFactory=new nodom.ExpressionFactory(this);this.directiveFactory=new nodom.DirectiveFactory(this);if(config){this.initConfig=config;if(nodom.Util.isString(config.el)){this.containerParam={module:config.parentName,selector:config.el}}else if(nodom.Util.isEl(config.el)){this.container=config.el}if(nodom.Util.isObject(config.methods)){nodom.Util.getOwnProps(config.methods).forEach(function(item){_this.methodFactory.add(item,config.methods[item])})}if(this.hasContainer()){this.template=this.container.innerHTML.trim();this.container.innerHTML=""}if(main){this.main=true;nodom.ModuleFactory.setMain(this)}}}Module.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){function changeState(mod){if(mod.main){mod.state=3;nodom.Renderer.add(mod)}else if(mod.parentName){mod.state=nodom.ModuleFactory.get(mod.parentName).state}else{mod.state=1}}var config,typeArr,urlArr,appPath,head_1,templateStr,files,head_2;var _this=this;return __generator(this,function(_a){switch(_a.label){case 0:config=this.initConfig;typeArr=[];urlArr=[];appPath=nodom.Application.templatePath||"";if(nodom.Util.isArray(config.requires)&&config.requires.length>0){head_1=document.head;config.requires.forEach(function(item){var type;var url="";if(nodom.Util.isObject(item)){type=item["type"]||"js";url+=item["url"]}else{type="js";url+=item}if(type==="css"){var css=nodom.Util.get("link[href='"+url+"']");if(css!==null){return}css=nodom.Util.newEl("link");css.type="text/css";css.rel="stylesheet";css.href=url;head_1.appendChild(css);return}else if(type==="js"){var cs=nodom.Util.get("script[dsrc='"+url+"']");if(cs!==null){return}}typeArr.push(type);urlArr.push(url)})}templateStr=this.template;if(config.template){config.template=config.template.trim();if(config.template.startsWith("<")){templateStr=config.template}else{if(config.template.endsWith(".nd")){typeArr.push("compiled")}else{typeArr.push("template")}urlArr.push(appPath+config.template)}}if(!nodom.Util.isEmpty(templateStr)){this.virtualDom=nodom.Compiler.compile(this,templateStr)}if(config.data){if(nodom.Util.isObject(config.data)){this.model=new nodom.Model(config.data,this)}else{typeArr.push("data");urlArr.push(config["data"]);this.dataUrl=config.data}}if(!(typeArr.length>0))return[3,2];return[4,nodom.Linker.gen("getfiles",urlArr)];case 1:files=_a.sent();head_2=document.querySelector("head");files.forEach(function(file,ind){switch(typeArr[ind]){case"js":var script=nodom.Util.newEl("script");script.innerHTML=file;head_2.appendChild(script);script.setAttribute("dsrc",urlArr[ind]);script.innerHTML="";head_2.removeChild(script);break;case"template":_this.virtualDom=nodom.Compiler.compile(_this,file.trim());break;case"compiled":var arr=nodom.Serializer.deserialize(file,_this);_this.virtualDom=arr[0];_this.expressionFactory=arr[1];break;case"data":_this.model=new nodom.Model(JSON.parse(file),_this)}});_a.label=2;case 2:changeState(this);if(nodom.Util.isArray(this.initConfig.modules)){this.initConfig.modules.forEach(function(item){_this.addChild(item)})}delete this.initConfig;return[2]}})})};Module.prototype.render=function(){var _this=this;if(this.state!==3||!this.virtualDom||!this.hasContainer()){return false}var root=this.virtualDom.clone();if(this.firstRender){if(this.loadNewData&&this.dataUrl){nodom.Linker.gen("ajax",{url:this.dataUrl,type:"json"}).then(function(r){_this.model=new nodom.Model(r,_this);_this.doFirstRender(root)});this.loadNewData=false}else{this.doFirstRender(root)}}else{this.doModuleEvent("onBeforeRender");if(this.model){root.modelId=this.model.id;var oldTree=this.renderTree;this.renderTree=root;root.render(this,null);root.compare(oldTree,this.renderDoms);for(var i=this.renderDoms.length-1;i>=0;i--){var item=this.renderDoms[i];if(item.type==="del"){item.node.removeFromHtml(this);this.renderDoms.splice(i,1)}}this.renderDoms.forEach(function(item){item.node.renderToHtml(_this,item)})}this.doModuleEvent("onRender")}this.renderDoms=[];if(nodom.Util.isArray(this.children)){this.children.forEach(function(item){item.render()})}return true};Module.prototype.doFirstRender=function(root){var _this=this;this.doModuleEvent("onBeforeFirstRender");this.beforeFirstRenderOps.forEach(function(foo){nodom.Util.apply(foo,_this,[])});this.beforeFirstRenderOps=[];this.renderTree=root;if(this.model){root.modelId=this.model.id}root.render(this,null);if(root.children){root.children.forEach(function(item){item.renderToHtml(_this,{type:"fresh"})})}delete this.firstRender;this.doModuleEvent("onFirstRender");this.firstRenderOps.forEach(function(foo){nodom.Util.apply(foo,_this,[])});this.firstRenderOps=[]};Module.prototype.hasContainer=function(){if(this.container){return true}else if(this.containerParam!==undefined){var ct=void 0;if(this.containerParam["module"]===undefined){ct=document}else{var module_4=nodom.ModuleFactory.get(this.containerParam["module"]);if(module_4){ct=module_4.container}}if(ct){this.container=ct.querySelector(this.containerParam["selector"]);return this.container!==null}}return false};Module.prototype.dataChange=function(){nodom.Renderer.add(this)};Module.prototype.addChild=function(config){config.parentName=this.name;var chd=new Module(config);if(this.children===undefined){this.children=[]}this.children.push(chd);return chd};Module.prototype.send=function(toName,data){nodom.MessageQueue.add(this.name,toName,data)};Module.prototype.broadcast=function(data){var _this=this;if(this.parentName){var pmod=nodom.ModuleFactory.get(this.parentName);if(pmod&&pmod.children){this.send(pmod.name,data);pmod.children.forEach(function(m){if(m===_this){return}_this.send(m.name,data)})}}if(this.children!==undefined){this.children.forEach(function(m){_this.send(m.name,data)})}};Module.prototype.receive=function(fromName,data){this.doModuleEvent("onReceive",[fromName,data])};Module.prototype.active=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){switch(_a.label){case 0:if(this.state===3){return[2]}if(!(this.state===0))return[3,2];return[4,this.init()];case 1:_a.sent();this.state=3;return[3,3];case 2:this.state=3;_a.label=3;case 3:nodom.Renderer.add(this);if(nodom.Util.isArray(this.children)){this.children.forEach(function(m){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,m.active()];case 1:_a.sent();return[2]}})})})}return[2]}})})};Module.prototype.unactive=function(){if(this.main||this.state===2){return}this.state=2;this.firstRender=true;if(nodom.Util.isArray(this.children)){this.children.forEach(function(m){m.unactive()})}};Module.prototype.destroy=function(){if(nodom.Util.isArray(this.children)){this.children.forEach(function(m){m.destroy()})}nodom.ModuleFactory.remove(this.name)};Module.prototype.doModuleEvent=function(eventName,param){var foo=this.methodFactory.get(eventName);if(!foo){return}if(!param){param=[this.model]}else{param.unshift(this.model)}nodom.Util.apply(foo,this,param)};Module.prototype.addFirstRenderOperation=function(foo){if(!nodom.Util.isFunction(foo)){return}if(this.firstRenderOps.indexOf(foo)===-1){this.firstRenderOps.push(foo)}};Module.prototype.addBeforeFirstRenderOperation=function(foo){var me=this;if(!nodom.Util.isFunction(foo)){return}if(this.beforeFirstRenderOps.indexOf(foo)===-1){this.beforeFirstRenderOps.push(foo)}};return Module}();nodom.Module=Module})(nodom||(nodom={}));var nodom;(function(nodom){var ModuleFactory=function(){function ModuleFactory(){}ModuleFactory.add=function(name,item){this.items.set(name,item)};ModuleFactory.get=function(name){return this.items.get(name)};ModuleFactory.remove=function(name){this.items.delete(name)};ModuleFactory.setMain=function(m){this.mainModule=m};ModuleFactory.getMain=function(){return this.mainModule};ModuleFactory.items=new Map;return ModuleFactory}();nodom.ModuleFactory=ModuleFactory})(nodom||(nodom={}));var nodom;(function(nodom){var NodomError=function(_super){__extends(NodomError,_super);function NodomError(errorName,p1,p2,p3,p4){var _this=_super.call(this,errorName)||this;var msg=nodom.ErrorMsgs[errorName];if(msg===undefined){_this.message="未知错误";return _this}var params=[msg];if(p1){params.push(p1)}if(p2){params.push(p2)}if(p3){params.push(p3)}if(p4){params.push(p4)}_this.message=nodom.Util.compileStr.apply(null,params);return _this}return NodomError}(Error);nodom.NodomError=NodomError})(nodom||(nodom={}));var nodom;(function(nodom){var NodomEvent=function(){function NodomEvent(eventName,eventStr){var _this=this;this.name=eventName;if(eventStr){eventStr.split(":").forEach(function(item,i){item=item.trim();if(i===0){_this.handler=item}else{switch(item){case"delg":_this.delg=true;break;case"nopopo":_this.nopopo=true;break;case"once":_this.once=true;break;case"capture":_this.capture=true;break}}})}var dtype="ontouchend"in document?1:2;if(dtype===1){switch(this.name){case"click":this.name="tap";break;case"mousedown":this.name="touchstart";break;case"mouseup":this.name="touchend";break;case"mousemove":this.name="touchmove";break}}else{switch(this.name){case"tap":this.name="click";break;case"touchstart":this.name="mousedown";break;case"touchend":this.name="mouseup";break;case"touchmove":this.name="mousemove";break}}}NodomEvent.prototype.fire=function(e,el,dom){var module=nodom.ModuleFactory.get(this.moduleName);if(!module.hasContainer()){return}if(!dom){dom=module.renderTree.query(this.domKey)}if(!el){el=module.container.querySelector("[key='"+this.domKey+"']")}var model=module.modelFactory.get(dom.modelId);if(this.capture){handleSelf(this,e,model,module,el,dom);handleDelg(this,e,model,module,el,dom)}else{if(handleDelg(this,e,model,module,el,dom)){handleSelf(this,e,model,module,el,dom)}}if(this.events!==undefined&&this.events[this.name].length===0&&this.handler===undefined){if(ExternalEvent.touches[this.name]){ExternalEvent.unregist(this,el)}else{if(el!==null){el.removeEventListener(this.name,this.handleListener)}}}function handleDelg(eObj,e,model,module,el,dom){if(eObj.events===undefined){return true}var arr=eObj.events[eObj.name];if(nodom.Util.isArray(arr)){if(arr.length>0){for(var i=0;i<arr.length;i++){if(arr[i].el&&arr[i].el.contains(e.target)){arr[i].fire(e);if(arr[i].once){eObj.removeSubEvt(arr[i])}if(arr[i].nopopo){return false}}}}else{eObj.events.delete(eObj.name)}}return true}function handleSelf(eObj,e,model,module,el,dom){var foo=module.methodFactory.get(eObj.handler);if(nodom.Util.isFunction(foo)){if(eObj.nopopo){e.stopPropagation()}nodom.Util.apply(foo,model,[e,module,el,dom]);if(eObj.once){delete eObj.handler}}}};NodomEvent.prototype.bind=function(module,dom,el){var _this=this;this.moduleName=module.name;this.domKey=dom.key;if(ExternalEvent.touches[this.name]){ExternalEvent.regist(this,el)}else{this.handleListener=function(e){_this.fire(e,el,dom)};el.addEventListener(this.name,this.handleListener,this.capture)}};NodomEvent.prototype.delegateTo=function(module,vdom,el,parent,parentEl){this.domKey=vdom.key;this.moduleName=module.name;if(!parentEl){parentEl=document.body}if(!parent.events.hasOwnProperty(this.name)){var ev=new NodomEvent(this.name);ev.bind(module,parent,parentEl);parent.events[this.name]=ev}parent.events[this.name].addSubEvt(this)};NodomEvent.prototype.addSubEvt=function(ev){if(!this.events){this.events=new Map}if(!this.events.has(this.name)){this.events.set(this.name,new Array)}this.events.get(this.name).push(ev)};NodomEvent.prototype.removeSubEvt=function(ev){if(this.events===undefined||this.events[ev.name]===undefined){return}var ind=this.events[ev.name].indexOf(ev);if(ind!==-1){this.events[ev.name].splice(ind,1);if(this.events[ev.name].length===0){this.events.delete(ev.name)}}};NodomEvent.prototype.clone=function(){var _this=this;var evt=new NodomEvent(this.name);var arr=["delg","once","nopopo","useCapture","handler","handleEvent","module"];arr.forEach(function(item){evt[item]=_this[item]});return evt};return NodomEvent}();nodom.NodomEvent=NodomEvent;var ExternalEvent=function(){function ExternalEvent(){}ExternalEvent.regist=function(evtObj,el){var touchEvts=ExternalEvent.touches[evtObj.name];if(!nodom.Util.isEmpty(evtObj.touchListeners)){this.unregist(evtObj)}if(!el){var module_5=nodom.ModuleFactory.get(evtObj.moduleName);el=module_5.container.querySelector("[key='"+evtObj.domKey+"']")}evtObj.touchListeners=new Map;if(touchEvts&&el!==null){nodom.Util.getOwnProps(touchEvts).forEach(function(ev){evtObj.touchListeners[ev]=function(e){touchEvts[ev](e,evtObj)};el.addEventListener(ev,evtObj.touchListeners[ev],evtObj.capture)})}};ExternalEvent.unregist=function(evtObj,el){var evt=ExternalEvent.touches[evtObj.name];if(!el){var module_6=nodom.ModuleFactory.get(evtObj.moduleName);el=module_6.container.querySelector("[key='"+evtObj.domKey+"']")}if(evt){if(el!==null){nodom.Util.getOwnProps(evtObj.touchListeners).forEach(function(ev){el.removeEventListener(ev,evtObj.touchListeners[ev])})}}};ExternalEvent.touches={};return ExternalEvent}();nodom.ExternalEvent=ExternalEvent;ExternalEvent.touches={tap:{touchstart:function(e,evtObj){var tch=e.touches[0];evtObj.extParams={pos:{sx:tch.pageX,sy:tch.pageY,t:Date.now()}}},touchmove:function(e,evtObj){var pos=evtObj.extParams.pos;var tch=e.touches[0];var dx=tch.pageX-pos.sx;var dy=tch.pageY-pos.sy;if(Math.abs(dx)>5||Math.abs(dy)>5){pos.move=true}},touchend:function(e,evtObj){var pos=evtObj.extParams.pos;var dt=Date.now()-pos.t;if(pos.move===true||dt>200){return}evtObj.fire(e)}},swipe:{touchstart:function(e,evtObj){var tch=e.touches[0];var t=Date.now();evtObj.extParams={swipe:{oldTime:[t,t],speedLoc:[{x:tch.pageX,y:tch.pageY},{x:tch.pageX,y:tch.pageY}],oldLoc:{x:tch.pageX,y:tch.pageY}}}},touchmove:function(e,evtObj){var nt=Date.now();var tch=e.touches[0];var mv=evtObj.extParams["swipe"];if(nt-mv.oldTime>50){mv.speedLoc[0]={x:mv.speedLoc[1].x,y:mv.speedLoc[1].y};mv.speedLoc[1]={x:tch.pageX,y:tch.pageY};mv.oldTime[0]=mv.oldTime[1];mv.oldTime[1]=nt}mv.oldLoc={x:tch.pageX,y:tch.pageY}},touchend:function(e,evtObj){var mv=evtObj.extParams["swipe"];var nt=Date.now();var ind=nt-mv.oldTime[1]<30?0:1;var dx=mv.oldLoc.x-mv.speedLoc[ind].x;var dy=mv.oldLoc.y-mv.speedLoc[ind].y;var s=Math.sqrt(dx*dx+dy*dy);var dt=nt-mv.oldTime[ind];if(dt>300||s<10){return}var v0=s/dt;if(v0>.05){var sname="";if(dx<0&&Math.abs(dy/dx)<1){e.v0=v0;sname="swipeleft"}if(dx>0&&Math.abs(dy/dx)<1){e.v0=v0;sname="swiperight"}if(dy>0&&Math.abs(dx/dy)<1){e.v0=v0;sname="swipedown"}if(dy<0&&Math.abs(dx/dy)<1){e.v0=v0;sname="swipeup"}if(evtObj.name===sname){evtObj.fire(e)}}}}};ExternalEvent.touches["swipeleft"]=ExternalEvent.touches["swipe"];ExternalEvent.touches["swiperight"]=ExternalEvent.touches["swipe"];ExternalEvent.touches["swipeup"]=ExternalEvent.touches["swipe"];ExternalEvent.touches["swipedown"]=ExternalEvent.touches["swipe"]})(nodom||(nodom={}));var nodom;(function(nodom){var Renderer=function(){function Renderer(){}Renderer.add=function(module){if(module.state!==3){return}if(!this.waitList.includes(module.name)){this.waitList.push(module.name)}};Renderer.remove=function(module){var ind;if((ind=this.waitList.indexOf(module.name))!==-1){this.waitList.splice(ind,1)}};Renderer.render=function(){for(var i=0;i<this.waitList.length;i++){var m=nodom.ModuleFactory.get(this.waitList[i]);if(!m||m.render()){this.waitList.shift();i--}}};Renderer.waitList=[];return Renderer}();nodom.Renderer=Renderer})(nodom||(nodom={}));var nodom;(function(nodom){var _this=this;var Router=function(){function Router(){}Router.addPath=function(path){return __awaiter(this,void 0,void 0,function(){var i,li;return __generator(this,function(_a){for(i=0;i<this.waitList.length;i++){li=this.waitList[i];if(li===path){return[2]}if(li.indexOf(path)===0&&li.substr(path.length+1,1)==="/"){return[2]}}this.waitList.push(path);this.load();return[2]})})};Router.load=function(){return __awaiter(this,void 0,void 0,function(){var path;return __generator(this,function(_a){switch(_a.label){case 0:if(this.loading||this.waitList.length===0){return[2]}path=this.waitList.shift();this.loading=true;return[4,this.start(path)];case 1:_a.sent();this.loading=false;this.load();return[2]}})})};Router.start=function(path){return __awaiter(this,void 0,void 0,function(){function setRouteParamToModel(route){if(!route){return}var module=nodom.ModuleFactory.get(route.module);var o={path:route.path};if(!nodom.Util.isEmpty(route.data)){o["data"]=route.data}if(!module.model){module.model=new nodom.Model({},module)}module.model.set("$route",o)}var diff,parentModule,i,r,module_7,showPath,route,proute,_loop_1,this_1,i;return __generator(this,function(_a){switch(_a.label){case 0:diff=this.compare(this.currentPath,path);parentModule=diff[0]===null?nodom.ModuleFactory.getMain():nodom.ModuleFactory.get(diff[0].module);for(i=diff[1].length-1;i>=0;i--){r=diff[1][i];if(!r.module){continue}module_7=nodom.ModuleFactory.get(r.module);if(nodom.Util.isFunction(this.onDefaultLeave)){this.onDefaultLeave(module_7.model)}if(nodom.Util.isFunction(r.onLeave)){r.onLeave(module_7.model)}module_7.unactive()}if(!(diff[2].length===0))return[3,1];route=diff[0];proute=diff[3];if(route!==null){showPath=route.useParentPath&&proute?proute.fullPath:route.fullPath;route.setLinkActive(true);setRouteParamToModel(route)}return[3,5];case 1:_loop_1=function(i){var route,module_8;return __generator(this,function(_a){switch(_a.label){case 0:route=diff[2][i];if(!route||!route.module){return[2,"continue"]}if(!route.useParentPath){showPath=route.fullPath}if(!parentModule.routerKey){throw new nodom.NodomError("notexist",nodom.TipWords.routeView)}module_8=nodom.ModuleFactory.get(route.module);if(!module_8){throw new nodom.NodomError("notexist1",nodom.TipWords.module,route.module)}module_8.containerParam={module:parentModule.name,selector:"[key='"+parentModule.routerKey+"']"};module_8.addBeforeFirstRenderOperation(function(){nodom.Util.empty(module_8.container)});route.setLinkActive(true);delete module_8.container;module_8.firstRender=true;return[4,module_8.active()];case 1:_a.sent();setRouteParamToModel(route);if(nodom.Util.isFunction(this_1.onDefaultEnter)){this_1.onDefaultEnter(module_8.model)}if(nodom.Util.isFunction(route.onEnter)){route.onEnter(module_8.model)}parentModule=module_8;return[2]}})};this_1=this;i=0;_a.label=2;case 2:if(!(i<diff[2].length))return[3,5];return[5,_loop_1(i)];case 3:_a.sent();_a.label=4;case 4:i++;return[3,2];case 5:if(this.startStyle!==2&&showPath){if(this.showPath&&showPath.indexOf(this.showPath)===0){history.replaceState(path,"",nodom.Application.routerPrePath+showPath)}else{history.pushState(path,"",nodom.Application.routerPrePath+showPath)}this.showPath=showPath}this.currentPath=path;this.startStyle=0;return[2]}})})};Router.redirect=function(path){this.addPath(path)};Router.addRoute=function(route,parent){if(RouterTree.add(route,parent)===false){throw new nodom.NodomError("exist1",nodom.TipWords.route,route.path)}this.routes.set(route.id,route)};Router.getRoute=function(path,last){if(!path){return null}var routes=RouterTree.get(path);if(routes===null||routes.length===0){return null}if(last){return[routes.pop()]}else{return routes}};Router.compare=function(path1,path2){var arr1=null;var arr2=null;if(path1){arr1=this.getRoute(path1)}if(path2){arr2=this.getRoute(path2)}var len=0;if(arr1!==null){len=arr1.length}if(arr2!==null){if(arr2.length<len){len=arr2.length}}else{len=0}var retArr1=[];var retArr2=[];var i=0;for(i=0;i<len;i++){if(arr1[i].id===arr2[i].id){if(JSON.stringify(arr1[i].data)!==JSON.stringify(arr2[i].data)){i++;break}}else{break}}if(arr1!==null){for(var j=i;j<arr1.length;j++){retArr1.push(arr1[j])}}if(arr2!==null){for(var j=i;j<arr2.length;j++){retArr2.push(arr2[j])}}var p1=null;var p2=null;if(arr1!==null&&i>0){for(var j=i-1;j>=0&&(p1===null||p2===null);j--){if(arr1[j].module!==undefined){if(p1===null){p1=arr1[j]}else if(p2===null){p2=arr1[j]}}}}return[p1,retArr1,retArr2,p2]};Router.changeActive=function(module,path){if(!module||!path||path===""){return}var domArr=Router.activeDomMap.get(module.name);if(!domArr){return}domArr.forEach(function(item){var dom=module.renderTree.query(item);if(!dom){return}var domPath=dom.props["path"];if(dom.exprProps.hasOwnProperty("active")){var model=module.modelFactory.get(dom.modelId);if(!model){return}var expr=module.expressionFactory.get(dom.exprProps["active"][0]);if(!expr){return}var field=expr.fields[0];if(path===domPath||path.indexOf(domPath+"/")===0){model.data[field]=true}else{model.data[field]=false}}else if(dom.props.hasOwnProperty("active")){if(path===domPath||path.indexOf(domPath+"/")===0){dom.props["active"]=true}else{dom.props["active"]=false}}})};Router.loading=false;Router.routes=new Map;Router.currentPath="";Router.showPath="";Router.waitList=[];Router.currentIndex=0;Router.moduleRouteMap=new Map;Router.startStyle=0;Router.activeDomMap=new Map;return Router}();nodom.Router=Router;var Route=function(){function Route(config){var _this=this;this.params=[];this.data={};this.children=[];this.onEnter=config.onEnter;this.onLeave=config.onLeave;this.useParentPath=config.useParentPath;this.path=config.path;this.module=config.module instanceof nodom.Module?config.module.name:config.module;if(config.path===""){return}this.id=nodom.Util.genId();if(!config.notAdd){Router.addRoute(this,config.parent)}if(nodom.Util.isArray(config.routes)){config.routes.forEach(function(item){item.parent=_this;new Route(item)})}}Route.prototype.setLinkActive=function(ancestor){var path=this.fullPath;var module=nodom.ModuleFactory.get(this.module);if(module&&module.containerParam){var pm=nodom.ModuleFactory.get(module.containerParam["module"]);if(pm){Router.changeActive(pm,path)}}if(ancestor&&this.parent){this.parent.setLinkActive(true)}};return Route}();nodom.Route=Route;var RouterTree=function(){function RouterTree(){}RouterTree.add=function(route,parent){if(!this.root){this.root=new Route({path:"",notAdd:true})}var pathArr=route.path.split("/");var node=parent||this.root;var param=[];var paramIndex=-1;var prePath="";for(var i=0;i<pathArr.length;i++){var v=pathArr[i].trim();if(v===""){pathArr.splice(i--,1);continue}if(v.startsWith(":")){if(param.length===0){paramIndex=i}param.push(v.substr(1))}else{paramIndex=-1;param=[];route.path=v;var j=0;for(;j<node.children.length;j++){var r=node.children[j];if(r.path===v){node=r;break}}if(j===node.children.length){if(prePath!==""){node.children.push(new Route({path:prePath,notAdd:true}));node=node.children[node.children.length-1]}prePath=v}}if(paramIndex===-1){route.params=[]}else{route.params=param}}if(node!==undefined&&node!==route){route.path=prePath;node.children.push(route)}return true};RouterTree.get=function(path){if(!this.root){throw new nodom.NodomError("notexist",nodom.TipWords.root)}var pathArr=path.split("/");var node=this.root;var paramIndex=0;var retArr=[];var fullPath="";var showPath="";var preNode=this.root;for(var i=0;i<pathArr.length;i++){var v=pathArr[i].trim();if(v===""){continue}var find=false;for(var j=0;j<node.children.length;j++){if(node.children[j].path===v){if(preNode!==this.root){preNode.fullPath=fullPath;preNode.data=node.data;retArr.push(preNode)}node=node.children[j];node.data={};preNode=node;find=true;break}}fullPath+="/"+v;if(!find){if(paramIndex<node.params.length){node.data[node.params[paramIndex++]]=v}}}if(node!==this.root){node.fullPath=fullPath;retArr.push(node)}return retArr};return RouterTree}();window.addEventListener("popstate",function(e){var state=history.state;if(!state){return}Router.startStyle=2;Router.addPath(state)});nodom.DirectiveManager.addType("route",{init:function(directive,dom,module){var value=directive.value;if(nodom.Util.isEmpty(value)){return}if(dom.tagName==="A"){dom.props["href"]="javascript:void(0)"}if(value&&value.substr(0,2)==="{{"&&value.substr(value.length-2,2)==="}}"){var expr=new nodom.Expression(value.substring(2,value.length-2),module);dom.exprProps["path"]=expr;directive.value=expr}else{dom.props["path"]=value}var method="$nodomGenMethod"+nodom.Util.genId();module.methodFactory.add(method,function(e,module,view,dom){return __awaiter(_this,void 0,void 0,function(){var path;return __generator(this,function(_a){path=dom.props["path"];if(nodom.Util.isEmpty(path)){return[2]}Router.addPath(path);return[2]})})});dom.events["click"]=new nodom.NodomEvent("click",method)},handle:function(directive,dom,module,parent){if(dom.props.hasOwnProperty("active")){var domArr=Router.activeDomMap.get(module.name);if(!domArr){Router.activeDomMap.set(module.name,[dom.key])}else{if(!domArr.includes(dom.key)){domArr.push(dom.key)}}}var path=dom.props["path"];if(path===Router.currentPath){return}if(dom.props.hasOwnProperty("active")&&dom.props["active"]!=="false"&&(!Router.currentPath||path.indexOf(Router.currentPath)===0)){Router.addPath(path)}}});nodom.DirectiveManager.addType("router",{init:function(directive,dom,module){module.routerKey=dom.key},handle:function(directive,dom,module,parent){return}})})(nodom||(nodom={}));var nodom;(function(nodom){var Scheduler=function(){function Scheduler(){}Scheduler.dispatch=function(){Scheduler.tasks.forEach(function(item){if(nodom.Util.isFunction(item.func)){if(item.thiser){item.func.call(item.thiser)}else{item.func()}}})};Scheduler.start=function(){Scheduler.dispatch();if(window.requestAnimationFrame){window.requestAnimationFrame(Scheduler.start)}else{window.setTimeout(Scheduler.start,nodom.Application.renderTick)}};Scheduler.addTask=function(foo,thiser){if(!nodom.Util.isFunction(foo)){throw new nodom.NodomError("invoke","Scheduler.addTask","0","function")}Scheduler.tasks.push({func:foo,thiser:thiser})};Scheduler.removeTask=function(foo){if(!nodom.Util.isFunction(foo)){throw new nodom.NodomError("invoke","Scheduler.removeTask","0","function")}var ind=-1;if((ind=Scheduler.tasks.indexOf(foo))!==-1){Scheduler.tasks.splice(ind,1)}};Scheduler.tasks=[];return Scheduler}();nodom.Scheduler=Scheduler})(nodom||(nodom={}));var nodom;(function(nodom){var Serializer=function(){function Serializer(){}Serializer.serialize=function(module){var props=["virtualDom","expressionFactory"];var jsonStr="[";props.forEach(function(p,i){addClsName(module[p]);var s=JSON.stringify(module[p]);jsonStr+=s;if(i<props.length-1){jsonStr+=","}else{jsonStr+="]"}});return jsonStr;function addClsName(obj){if(typeof obj!=="object"){return}obj.className=obj.constructor.name;nodom.Util.getOwnProps(obj).forEach(function(item){if(nodom.Util.isArray(obj[item])){if(obj[item].length===0){delete obj[item]}else{obj[item].forEach(function(item1){addClsName(item1)})}}else if(typeof obj[item]==="object"){if(nodom.Util.isEmpty(obj[item])){delete obj[item]}else{addClsName(obj[item])}}})}};Serializer.deserialize=function(jsonStr,module){var jsonArr=JSON.parse(jsonStr);var arr=[];var vdom;jsonArr.forEach(function(item){arr.push(handleCls(item))});return arr;function handleCls(jsonObj){if(!nodom.Util.isObject(jsonObj)){return jsonObj}if(jsonObj.moduleName){jsonObj.moduleName=module.name}var retObj;if(jsonObj.hasOwnProperty("className")){var cls=jsonObj["className"];var param=[];switch(cls){case"Directive":param=[jsonObj["type"],jsonObj["value"],vdom,module];break;case"Event":param=[jsonObj["name"]];break}var clazz=eval(cls);if(cls==="Element"){vdom=retObj}}else{retObj={}}var objArr=[];var arrArr=[];nodom.Util.getOwnProps(jsonObj).forEach(function(item){if(nodom.Util.isObject(jsonObj[item])){objArr.push(item)}else if(nodom.Util.isArray(jsonObj[item])){arrArr.push(item)}else{if(item!=="className"){retObj[item]=jsonObj[item]}}});objArr.forEach(function(item){retObj[item]=handleCls(jsonObj[item])});arrArr.forEach(function(item){retObj[item]=[];jsonObj[item].forEach(function(item1){retObj[item].push(handleCls(item1))})});return retObj}};return Serializer}();nodom.Serializer=Serializer})(nodom||(nodom={}));var nodom;(function(nodom){nodom.DirectiveManager.addType("model",{prio:1,init:function(directive,dom,module,el){var value=directive.value;if(nodom.Util.isString(value)){var arr_1=new Array;value.split(".").forEach(function(item){var ind1=-1,ind2=-1;if((ind1=item.indexOf("["))!==-1&&(ind2=item.indexOf("]"))!==-1){var fn=item.substr(0,ind1);var index=item.substring(ind1+1,ind2);arr_1.push(fn+","+index)}else{arr_1.push(item)}});directive.value=arr_1}},handle:function(directive,dom,module,parent){var model=module.modelFactory.get(dom.modelId+"");if(!model||!model.data){return}var data=model.data;directive.value.forEach(function(item){if(!data){return}if(item.indexOf(",")!==-1){var a=item.split(",");data=data[a[0]][parseInt(a[1])]}else{data=data[item]}});if(data){dom.modelId=data.$modelId}return true}});nodom.DirectiveManager.addType("repeat",{prio:2,init:function(directive,dom,module,el){var value=directive.value;if(!value){throw new nodom.NodomError("paramException","x-repeat")}var ind;var modelName;if((ind=value.indexOf("|"))!==-1){modelName=value.substr(0,ind).trim();directive.filter=new nodom.Filter(value.substr(ind+1))}else{modelName=value}if(!dom.hasDirective("mocel")){dom.directives.push(new nodom.Directive("model",modelName,dom,module))}directive.value=modelName},handle:function(directive,dom,module,parent){var modelFac=module.modelFactory;var rows=modelFac.get(dom.modelId+"").data;if(directive.filter!==undefined){rows=directive.filter.exec(rows,module)}if(rows===undefined||rows.length===0){dom.dontRender=true;return true}var chds=[];var key=dom.key;dom.removeDirectives(["model","repeat"]);for(var i=0;i<rows.length;i++){var node=dom.clone();node.modelId=rows[i].$modelId;setKey(node,key,node.modelId);rows[i].$index=i;chds.push(node)}if(chds.length>0){for(var i=0,len=parent.children.length;i<len;i++){if(parent.children[i]===dom){chds=[i+1,0].concat(chds);Array.prototype.splice.apply(parent.children,chds);break}}}dom.dontRender=true;return false;function setKey(node,key,id){node.key=key+"_"+id;node.children.forEach(function(dom){setKey(dom,dom.key,id)})}}});nodom.DirectiveManager.addType("if",{init:function(directive,dom,module,el){var value=directive.value;if(!value){throw new nodom.NodomError("paramException","x-repeat")}var expr=new nodom.Expression(value,module);directive.value=expr},handle:function(directive,dom,module,parent){var model=module.modelFactory.get(dom.modelId);var v=directive.value.val(model);var indif=-1,indelse=-1;for(var i=0;i<parent.children.length;i++){if(parent.children[i]===dom){indif=i}else if(indelse===-1&&parent.children[i].hasDirective("else")){indelse=i}if(i!==indif&&indif!==-1&&indelse===-1&&parent.children[i].tagName!==undefined){indelse=-2}if(indif!==-1&&indelse!==-1){break}}if(v&&v!=="false"){var ind=0;if(indelse>0){parent.children[indelse].dontRender=true}}else if(indelse>0){dom.dontRender=true}return true}});nodom.DirectiveManager.addType("else",{name:"else",init:function(directive,dom,module,el){return},handle:function(directive,dom,module,parent){return}});nodom.DirectiveManager.addType("show",{init:function(directive,dom,module,el){var value=directive.value;if(!value){throw new nodom.NodomError("paramException","x-show")}var expr=new nodom.Expression(value,module);directive.value=expr},handle:function(directive,dom,module,parent){var model=module.modelFactory.get(dom.modelId);var v=directive.value.val(model);if(v&&v!=="false"){dom.dontRender=false}else{dom.dontRender=true}}});nodom.DirectiveManager.addType("class",{init:function(directive,dom,module,el){var obj=eval("("+directive.value+")");if(!nodom.Util.isObject(obj)){return}var robj={};nodom.Util.getOwnProps(obj).forEach(function(key){if(nodom.Util.isString(obj[key])){robj[key]=new nodom.Expression(obj[key],module)}else{robj[key]=obj[key]}});directive.value=robj},handle:function(directive,dom,module,parent){var obj=directive.value;var clsArr=[];var cls=dom.props["class"];var model=module.modelFactory.get(dom.modelId);if(nodom.Util.isString(cls)&&!nodom.Util.isEmpty(cls)){clsArr=cls.trim().split(/\s+/)}nodom.Util.getOwnProps(obj).forEach(function(key){var r=obj[key];if(r instanceof nodom.Expression){r=r.val(model)}var ind=clsArr.indexOf(key);if(!r||r==="false"){if(ind!==-1){clsArr.splice(ind,1)}}else if(ind===-1){clsArr.push(key)}});dom.props["class"]=clsArr.join(" ")}});nodom.DirectiveManager.addType("field",{init:function(directive,dom,module,el){var dv=directive.value;var field=dv;var tgname=dom.tagName.toLowerCase();var type=dom.props["type"];var eventName="input";if(tgname==="input"&&(type==="checkbox"||type==="radio")){eventName="change"}dom.props["name"]=field;var method="$nodomGenMethod"+nodom.Util.genId();module.methodFactory.add(method,function(e,module,view,dom){var type=dom.props["type"];var model=module.modelFactory.get(dom.modelId);var field=dom.getDirective("field").value;var v=view.value;if(type==="checkbox"){if(dom.props["yes-value"]==v){v=dom.props["no-value"]}else{v=dom.props["yes-value"]}}else if(type==="radio"){if(!view.checked){v=undefined}}this.data[field]=v;if(type!=="radio"){dom.props["value"]=v;view.value=v}});dom.events[eventName]=new nodom.NodomEvent(eventName,method);setTimeout(function(){if(!dom.exprProps.hasOwnProperty("value")&&!dom.props.hasOwnProperty("value")){dom.exprProps["value"]=new nodom.Expression(field,module)}},0)},handle:function(directive,dom,module,parent){var type=dom.props["type"];var tgname=dom.tagName.toLowerCase();var model=module.modelFactory.get(dom.modelId);var dataValue=model.data[directive.value];var value=dom.props["value"];if(type==="radio"){if(dataValue==value){dom.props["checked"]="checked"}else{delete dom.props["checked"]}}else if(type==="checkbox"){var yv=dom.props["yes-value"];if(dataValue==yv){dom.props["checked"]="checked";dom.props["value"]=yv}else{delete dom.props["checked"];dom.props["value"]=dom.props["no-value"]}}else if(tgname==="select"){dom.props["value"]=dataValue;setTimeout(function(){var inputEl=module.container.querySelector("[key='"+dom.key+"']");inputEl.value=dataValue},0)}}});nodom.DirectiveManager.addType("validity",{init:function(directive,dom,module,el){var ind,fn,method;var value=directive.value;if((ind=value.indexOf("|"))!==-1){fn=value.substr(0,ind);method=value.substr(ind+1)}else{fn=value}directive.value=fn;directive.params={enabled:false};if(method){directive.params.method=method}setTimeout(function(){if(dom.children.length===0){var vd1=new nodom.Element;vd1.textContent="   ";dom.children.push(vd1)}else{dom.children.forEach(function(item){if(item.children.length===0){var vd1=new nodom.Element;vd1.textContent="   ";item.children.push(vd1)}})}},0);module.addFirstRenderOperation(function(){var m=this;var el=module.container.querySelector("[name='"+directive.value+"']");if(el){el.addEventListener("focus",function(){directive.params.enabled=true});el.addEventListener("blur",function(){nodom.Renderer.add(m)})}})},handle:function(directive,dom,module,parent){var el=module.container.querySelector("[name='"+directive.value+"']");if(!directive.params.enabled){dom.dontRender=true;return}var chds=[];dom.children.forEach(function(item){if(item.tagName!==undefined&&item.props.hasOwnProperty("rel")){chds.push(item)}});var resultArr=[];if(directive.params.method){var foo=module.methodFactory.get(directive.params.method);if(nodom.Util.isFunction(foo)){var r=foo.call(module.model,el.value);if(!r){resultArr.push("custom")}}}var vld=el.validity;if(!vld.valid){for(var o in vld){if(vld[o]===true){resultArr.push(o)}}}if(resultArr.length>0){var vn=handle(resultArr);if(chds.length===0){setTip(dom,vn,el)}else{for(var i=0;i<chds.length;i++){var rel=chds[i].props["rel"];if(rel===vn){setTip(chds[i],vn,el)}else{chds[i].dontRender=true}}}}else{dom.dontRender=true}function setTip(vd,vn,el){var text=vd.children[0].textContent.trim();if(text===""){text=nodom.Util.compileStr(nodom.FormMsgs[vn],el.getAttribute(vn))}vd.children[0].textContent=text}function handle(arr){for(var i=0;i<arr.length;i++){switch(arr[i]){case"valueMissing":return"required";case"typeMismatch":return"type";case"tooLong":return"maxLength";case"tooShort":return"minLength";case"rangeUnderflow":return"min";case"rangeOverflow":return"max";case"patternMismatch":return"pattern";default:return arr[i]}}}}})})(nodom||(nodom={}));var nodom;(function(nodom){nodom.FilterManager.addType("date",function(value,param){if(nodom.Util.isEmpty(value)){return""}param=param.substr(1,param.length-2);return nodom.Util.formatDate(value,param)});nodom.FilterManager.addType("currency",function(value,sign){if(isNaN(value)){return""}sign=sign||"¥";if(typeof value==="string"){value=parseFloat(value)}return sign+(value*100+.5|0)/100});nodom.FilterManager.addType("number",function(value,param){var digits=param||0;if(isNaN(value)||digits<0){return""}if(typeof value==="string"){value=parseFloat(value)}var x=1;for(var i=0;i<digits;i++){x*=10}return(value*x+.5|0)/x});nodom.FilterManager.addType("tolowercase",function(value){if(nodom.Util.isEmpty(value)){return""}if(!nodom.Util.isString(value)||nodom.Util.isEmpty(value)){throw new nodom.NodomError("invoke1",nodom.TipWords.filter+" tolowercase","0","string")}return value.toLowerCase()});nodom.FilterManager.addType("touppercase",function(value){if(nodom.Util.isEmpty(value)){return""}if(!nodom.Util.isString(value)||nodom.Util.isEmpty(value)){throw new nodom.NodomError("invoke1",nodom.TipWords.filter+" touppercase","0","string")}return value.toUpperCase()});nodom.FilterManager.addType("orderby",function(){var args=arguments;var arr=args[0];var field=args[1];var odr=args[2]||"asc";if(!nodom.Util.isArray(arr)){throw new nodom.NodomError("invoke1",nodom.TipWords.filter+" orderby","0","array")}var ret=arr.concat([]);if(field&&nodom.Util.isObject(arr[0])){if(odr==="asc"){ret.sort(function(a,b){return a[field]>=b[field]?1:-1})}else{ret.sort(function(a,b){return b[field]<=a[field]?1:-1})}}else{if(odr==="asc"){ret.sort(function(a,b){return a>=b?1:-1})}else{ret.sort(function(a,b){return b<=a?1:-1})}}return ret});nodom.FilterManager.addType("select",function(){if(!nodom.Util.isArray(arguments[0])){throw new nodom.NodomError("invoke1",nodom.TipWords.filter+" filter","0","array")}var params=new Array;for(var i=0;i<arguments.length;i++){params.push(arguments[i])}var handler={odd:function(){var arr=arguments[0];var ret=[];for(var i=0;i<arr.length;i++){if(i%2===1){ret.push(arr[i])}}return ret},even:function(){var arr=arguments[0];var ret=[];for(var i=0;i<arr.length;i++){if(i%2===0){ret.push(arr[i])}}return ret},range:function(){var args=arguments;var arr=args[0];var ret=[];var first=args[1];var last=args[2];if(isNaN(first)){throw new nodom.NodomError("paramException",nodom.TipWords.filter,"filter range")}if(!nodom.Util.isNumber(first)){first=parseInt(first)}if(isNaN(last)){throw new nodom.NodomError("paramException",nodom.TipWords.filter,"filter range")}if(!nodom.Util.isNumber(last)){last=parseInt(last)}if(first>last){throw new nodom.NodomError("paramException",nodom.TipWords.filter,"filter range")}return arr.slice(first,last+1)},index:function(){var args=arguments;var arr=args[0];if(!nodom.Util.isArray(args[0])){throw new nodom.NodomError("paramException",nodom.TipWords.filter,"filter index")}var ret=[];if(arr.length>0){for(var i=1;i<args.length;i++){if(isNaN(args[i])){continue}var k=parseInt(args[i]);if(k<arr.length){ret.push(arr[k])}}}return ret},func:function(arr,param){if(!nodom.Util.isArray(arr)||nodom.Util.isEmpty(param)){throw new nodom.NodomError("paramException",nodom.TipWords.filter,"filter func")}var foo=this.methodFactory.get(param);if(nodom.Util.isFunction(foo)){return foo(arr)}return arr},value:function(arr,param){if(!nodom.Util.isArray(arr)||nodom.Util.isEmpty(param)){throw new nodom.NodomError("paramException",nodom.TipWords.filter,"filter value")}if(nodom.Util.isObject(param)){var keys_1=nodom.Util.getOwnProps(param);return arr.filter(function(item){for(var i=0;i<keys_1.length;i++){var v=item[keys_1[i]];var v1=param[keys_1[i]];if(v===undefined||v!==v1&&typeof v==="string"&&v.indexOf(v1)===-1){return false}}return true})}else{return arr.filter(function(item){var props=nodom.Util.getOwnProps(item);for(var i=0;i<props.length;i++){var v=item[props[i]];if(nodom.Util.isString(v)&&v.indexOf(param)!==-1){return item}}})}}};var type;if(nodom.Util.isString(params[1])){type=params[1].trim();if(handler.hasOwnProperty(type)){params.splice(1,1)}else{type="value"}}else{type="value"}if(type==="range"||type==="index"||type==="func"){if(params.length<2){throw new nodom.NodomError("paramException",nodom.TipWords.filter)}}return nodom.Util.apply(handler[type],this,params)});nodom.FilterManager.addType("html",function(value){if(nodom.Util.isEmpty(value)){return""}var div=nodom.Util.newEl("div");div.innerHTML=value;var frag=document.createDocumentFragment();for(var i=0;i<div.childNodes.length;i++){frag.appendChild(div.childNodes[i])}return frag})})(nodom||(nodom={}));var nodom;(function(nodom){nodom.TipWords={application:"应用",system:"系统",module:"模块",moduleClass:"模块类",model:"模型",directive:"指令",directiveType:"指令类型",expression:"表达式",event:"事件",method:"方法",filter:"过滤器",filterType:"过滤器类型",data:"数据",dataItem:"数据项",route:"路由",routeView:"路由容器",plugin:"插件",resource:"资源",root:"根"};nodom.ErrorMsgs={unknown:"未知错误",paramException:"{0}'{1}'方法参数错误，请参考api",invoke:"{0}方法调用参数{1}必须为{2}",invoke1:"{0}方法调用参数{1}必须为{2}或{3}",invoke2:"{0}方法调用参数{1}或{2}必须为{3}",invoke3:"{0}方法调用参数{1}不能为空",exist:"{0}已存在",exist1:"{0}'{1}'已存在",notexist:"{0}不存在",notexist1:"{0}'{1}'不存在",notupd:"{0}不可修改",notremove:"{0}不可删除",notremove1:"{0}{1}不可删除",namedinvalid:"{0}{1}命名错误，请参考用户手册对应命名规范",initial:"{0}初始化参数错误",jsonparse:"JSON解析错误",timeout:"请求超时",config:"{1}配置参数错误"};nodom.FormMsgs={type:"请输入有效的{0}",unknown:"输入错误",required:"不能为空",min:"最小输入值为{0}",max:"最大输入值为{0}"}})(nodom||(nodom={}));